0000	2f 2f 20 63 6f 6e 73 74  20 44 61 74 61 62 61 73   // const Databas
0010	65 20 3d 20 72 65 71 75  69 72 65 28 27 62 65 74   e = require('bet
0020	74 65 72 2d 73 71 6c 69  74 65 33 27 29 3b 0d 0a   ter-sqlite3');..
0030	63 6f 6e 73 74 20 70 61  74 68 20 3d 20 72 65 71   const path = req
0040	75 69 72 65 28 27 70 61  74 68 27 29 3b 0d 0a 63   uire('path');..c
0050	6f 6e 73 74 20 6d 79 73  71 6c 20 3d 20 72 65 71   onst mysql = req
0060	75 69 72 65 28 27 6d 79  73 71 6c 32 2f 70 72 6f   uire('mysql2/pro
0070	6d 69 73 65 27 29 3b 0d  0a 0d 0a 2f 2f 20 44 61   mise');....// Da
0080	74 61 62 61 73 65 20 43  4f 4e 54 52 4f 4c 45 47   tabase CONTROLEG
0090	45 52 41 4c 20 2d 20 44  65 73 61 62 69 6c 69 74   ERAL - Desabilit
00a0	61 64 6f 20 70 61 72 61  20 52 65 6e 64 65 72 0d   ado para Render.
00b0	0a 2f 2f 20 63 6f 6e 73  74 20 64 62 50 61 74 68   .// const dbPath
00c0	20 3d 20 70 61 74 68 2e  6a 6f 69 6e 28 5f 5f 64    = path.join(__d
00d0	69 72 6e 61 6d 65 2c 20  27 2e 2e 2f 2e 2e 2f 43   irname, '../../C
00e0	4f 4e 54 52 4f 4c 45 47  45 52 41 4c 2f 62 61 63   ONTROLEGERAL/bac
00f0	6b 65 6e 64 2f 63 6f 6e  73 74 72 75 74 6f 72 61   kend/construtora
0100	2e 64 62 27 29 3b 0d 0a  2f 2f 20 6c 65 74 20 64   .db');..// let d
0110	62 3b 0d 0a 2f 2f 20 74  72 79 20 7b 0d 0a 2f 2f   b;..// try {..//
0120	20 64 62 20 3d 20 6e 65  77 20 44 61 74 61 62 61    db = new Databa
0130	73 65 28 64 62 50 61 74  68 29 3b 0d 0a 2f 2f 20   se(dbPath);..// 
0140	63 6f 6e 73 6f 6c 65 2e  6c 6f 67 28 27 e2 9c 85   console.log('...
0150	20 43 6f 6e 65 63 74 61  64 6f 20 61 6f 20 62 61    Conectado ao ba
0160	6e 63 6f 20 43 4f 4e 54  52 4f 4c 45 47 45 52 41   nco CONTROLEGERA
0170	4c 27 29 3b 0d 0a 2f 2f  20 7d 20 63 61 74 63 68   L');..// } catch
0180	20 28 65 72 72 29 20 7b  0d 0a 2f 2f 20 63 6f 6e    (err) {..// con
0190	73 6f 6c 65 2e 65 72 72  6f 72 28 27 45 72 72 6f   sole.error('Erro
01a0	20 61 6f 20 63 6f 6e 65  63 74 61 72 20 61 6f 20    ao conectar ao 
01b0	62 61 6e 63 6f 20 43 4f  4e 54 52 4f 4c 45 47 45   banco CONTROLEGE
01c0	52 41 4c 3a 27 2c 20 65  72 72 2e 6d 65 73 73 61   RAL:', err.messa
01d0	67 65 29 3b 0d 0a 2f 2f  20 7d 0d 0a 2f 2f 20 4d   ge);..// }..// M
01e0	61 69 6e 20 64 61 74 61  62 61 73 65 20 66 6f 72   ain database for
01f0	20 6f 62 72 61 73 0d 0a  63 6f 6e 73 74 20 6d 61    obras..const ma
0200	69 6e 44 62 20 3d 20 72  65 71 75 69 72 65 28 27   inDb = require('
0210	2e 2e 2f 64 61 74 61 62  61 73 65 2f 63 6f 6e 6e   ../database/conn
0220	65 63 74 69 6f 6e 27 29  3b 0d 0a 0d 0a 63 6f 6e   ection');....con
0230	73 74 20 64 62 20 3d 20  6d 61 69 6e 44 62 3b 0d   st db = mainDb;.
0240	0a 0d 0a 2f 2f 20 63 6f  6e 74 72 6f 6c 65 20 67   ...// controle g
0250	65 72 61 6c 0d 0a 65 78  70 6f 72 74 73 2e 63 6f   eral..exports.co
0260	6e 74 72 6f 6c 65 47 65  72 61 6c 20 3d 20 61 73   ntroleGeral = as
0270	79 6e 63 20 28 72 65 71  2c 20 72 65 73 29 20 3d   ync (req, res) =
0280	3e 20 7b 0d 0a 20 74 72  79 20 7b 0d 0a 20 72 65   > {.. try {.. re
0290	73 2e 72 65 6e 64 65 72  28 27 63 6f 6e 74 72 6f   s.render('contro
02a0	6c 65 67 65 72 61 6c 27  29 3b 0d 0a 20 7d 20 63   legeral');.. } c
02b0	61 74 63 68 20 28 65 72  72 29 20 7b 0d 0a 20 63   atch (err) {.. c
02c0	6f 6e 73 6f 6c 65 2e 65  72 72 6f 72 28 27 45 72   onsole.error('Er
02d0	72 6f 20 61 6f 20 63 61  72 72 65 67 61 72 20 63   ro ao carregar c
02e0	6f 6e 74 72 6f 6c 65 20  67 65 72 61 6c 3a 27 2c   ontrole geral:',
02f0	20 65 72 72 29 3b 0d 0a  20 72 65 73 2e 73 74 61    err);.. res.sta
0300	74 75 73 28 35 30 30 29  2e 72 65 6e 64 65 72 28   tus(500).render(
0310	27 65 72 72 6f 72 27 2c  20 7b 20 6d 65 73 73 61   'error', { messa
0320	67 65 3a 20 27 45 72 72  6f 20 69 6e 74 65 72 6e   ge: 'Erro intern
0330	6f 20 64 6f 20 73 65 72  76 69 64 6f 72 27 20 7d   o do servidor' }
0340	29 3b 0d 0a 20 7d 0d 0a  7d 3b 0d 0a 0d 0a 2f 2f   );.. }..};....//
0350	20 4f 42 52 41 53 0d 0a  65 78 70 6f 72 74 73 2e    OBRAS..exports.
0360	6f 62 72 61 73 20 3d 20  61 73 79 6e 63 20 28 72   obras = async (r
0370	65 71 2c 20 72 65 73 29  20 3d 3e 20 7b 0d 0a 20   eq, res) => {.. 
0380	74 72 79 20 7b 0d 0a 20  63 6f 6e 73 74 20 5b 6f   try {.. const [o
0390	62 72 61 73 5d 20 3d 20  61 77 61 69 74 20 64 62   bras] = await db
03a0	2e 65 78 65 63 75 74 65  28 27 53 45 4c 45 43 54   .execute('SELECT
03b0	20 2a 20 46 52 4f 4d 20  6f 62 72 61 73 20 4f 52    * FROM obras OR
03c0	44 45 52 20 42 59 20 69  64 20 44 45 53 43 27 29   DER BY id DESC')
03d0	3b 0d 0a 20 72 65 73 2e  72 65 6e 64 65 72 28 27   ;.. res.render('
03e0	6f 62 72 61 73 43 6f 6e  74 72 6f 6c 65 27 2c 20   obrasControle', 
03f0	7b 20 6f 62 72 61 73 3a  20 6f 62 72 61 73 20 7c   { obras: obras |
0400	7c 20 5b 5d 20 7d 29 3b  0d 0a 20 7d 20 63 61 74   | [] });.. } cat
0410	63 68 20 28 65 72 72 29  20 7b 0d 0a 20 63 6f 6e   ch (err) {.. con
0420	73 6f 6c 65 2e 65 72 72  6f 72 28 27 45 72 72 6f   sole.error('Erro
0430	20 61 6f 20 63 61 72 72  65 67 61 72 20 6f 62 72    ao carregar obr
0440	61 73 3a 27 2c 20 65 72  72 29 3b 0d 0a 20 72 65   as:', err);.. re
0450	73 2e 73 74 61 74 75 73  28 35 30 30 29 2e 72 65   s.status(500).re
0460	6e 64 65 72 28 27 65 72  72 6f 72 27 2c 20 7b 20   nder('error', { 
0470	6d 65 73 73 61 67 65 3a  20 27 45 72 72 6f 20 69   message: 'Erro i
0480	6e 74 65 72 6e 6f 20 64  6f 20 73 65 72 76 69 64   nterno do servid
0490	6f 72 27 20 7d 29 3b 0d  0a 20 7d 0d 0a 7d 3b 0d   or' });.. }..};.
04a0	0a 0d 0a 65 78 70 6f 72  74 73 2e 63 72 69 61 72   ...exports.criar
04b0	4f 62 72 61 20 3d 20 61  73 79 6e 63 20 28 72 65   Obra = async (re
04c0	71 2c 20 72 65 73 29 20  3d 3e 20 7b 0d 0a 20 74   q, res) => {.. t
04d0	72 79 20 7b 0d 0a 20 63  6f 6e 73 74 20 7b 20 6e   ry {.. const { n
04e0	6f 6d 65 2c 20 65 6e 64  65 72 65 63 6f 2c 20 63   ome, endereco, c
04f0	6c 69 65 6e 74 65 2c 20  6f 72 63 61 6d 65 6e 74   liente, orcament
0500	6f 2c 20 64 61 74 61 5f  69 6e 69 63 69 6f 2c 20   o, data_inicio, 
0510	64 61 74 61 5f 66 69 6d  2c 20 73 74 61 74 75 73   data_fim, status
0520	20 7d 20 3d 20 72 65 71  2e 62 6f 64 79 3b 0d 0a    } = req.body;..
0530	20 61 77 61 69 74 20 64  62 2e 65 78 65 63 75 74    await db.execut
0540	65 28 60 49 4e 53 45 52  54 20 49 4e 54 4f 20 6f   e(`INSERT INTO o
0550	62 72 61 73 20 28 6e 6f  6d 65 2c 20 65 6e 64 65   bras (nome, ende
0560	72 65 63 6f 2c 20 63 6c  69 65 6e 74 65 2c 20 6f   reco, cliente, o
0570	72 63 61 6d 65 6e 74 6f  2c 20 64 61 74 61 5f 69   rcamento, data_i
0580	6e 69 63 69 6f 2c 20 64  61 74 61 5f 66 69 6d 2c   nicio, data_fim,
0590	20 73 74 61 74 75 73 29  20 56 41 4c 55 45 53 20    status) VALUES 
05a0	28 3f 2c 20 3f 2c 20 3f  2c 20 3f 2c 20 3f 2c 20   (?, ?, ?, ?, ?, 
05b0	3f 2c 20 3f 29 60 2c 20  5b 6e 6f 6d 65 2c 20 65   ?, ?)`, [nome, e
05c0	6e 64 65 72 65 63 6f 2c  20 63 6c 69 65 6e 74 65   ndereco, cliente
05d0	2c 20 6f 72 63 61 6d 65  6e 74 6f 2c 20 64 61 74   , orcamento, dat
05e0	61 5f 69 6e 69 63 69 6f  2c 20 64 61 74 61 5f 66   a_inicio, data_f
05f0	69 6d 2c 20 73 74 61 74  75 73 5d 29 3b 0d 0a 20   im, status]);.. 
0600	72 65 73 2e 72 65 64 69  72 65 63 74 28 27 2f 64   res.redirect('/d
0610	61 73 68 62 6f 61 72 64  2f 63 6f 6e 74 72 6f 6c   ashboard/control
0620	65 20 67 65 72 61 6c 2f  6f 62 72 61 73 27 29 3b   e geral/obras');
0630	0d 0a 20 7d 20 63 61 74  63 68 20 28 65 72 72 29   .. } catch (err)
0640	20 7b 0d 0a 20 63 6f 6e  73 6f 6c 65 2e 65 72 72    {.. console.err
0650	6f 72 28 27 45 72 72 6f  20 61 6f 20 63 72 69 61   or('Erro ao cria
0660	72 20 6f 62 72 61 3a 27  2c 20 65 72 72 29 3b 0d   r obra:', err);.
0670	0a 20 72 65 73 2e 73 74  61 74 75 73 28 35 30 30   . res.status(500
0680	29 2e 6a 73 6f 6e 28 7b  20 65 72 72 6f 72 3a 20   ).json({ error: 
0690	27 45 72 72 6f 20 69 6e  74 65 72 6e 6f 20 64 6f   'Erro interno do
06a0	20 73 65 72 76 69 64 6f  72 27 20 7d 29 3b 0d 0a    servidor' });..
06b0	20 7d 0d 0a 20 7d 3b 0d  0a 0d 0a 65 78 70 6f 72    }.. };....expor
06c0	74 73 2e 65 64 69 74 61  72 4f 62 72 61 50 61 67   ts.editarObraPag
06d0	65 20 3d 20 61 73 79 6e  63 20 28 72 65 71 2c 20   e = async (req, 
06e0	72 65 73 29 20 3d 3e 20  7b 0d 0a 20 74 72 79 20   res) => {.. try 
06f0	7b 0d 0a 20 63 6f 6e 73  74 20 7b 20 69 64 20 7d   {.. const { id }
0700	20 3d 20 72 65 71 2e 70  61 72 61 6d 73 3b 0d 0a    = req.params;..
0710	20 63 6f 6e 73 74 20 5b  6f 62 72 61 5d 20 3d 20    const [obra] = 
0720	61 77 61 69 74 20 64 62  2e 65 78 65 63 75 74 65   await db.execute
0730	28 27 53 45 4c 45 43 54  20 2a 20 46 52 4f 4d 20   ('SELECT * FROM 
0740	6f 62 72 61 73 20 57 48  45 52 45 20 69 64 20 3d   obras WHERE id =
0750	20 3f 27 2c 20 5b 69 64  5d 29 3b 0d 0a 20 69 66    ?', [id]);.. if
0760	20 28 21 6f 62 72 61 5b  30 5d 29 20 7b 0d 0a 20    (!obra[0]) {.. 
0770	72 65 74 75 72 6e 20 72  65 73 2e 73 74 61 74 75   return res.statu
0780	73 28 34 30 34 29 2e 72  65 6e 64 65 72 28 27 65   s(404).render('e
0790	72 72 6f 72 27 2c 20 7b  20 6d 65 73 73 61 67 65   rror', { message
07a0	3a 20 27 4f 62 72 61 20  6e c3 a3 6f 20 65 6e 63   : 'Obra n..o enc
07b0	6f 6e 74 72 61 64 61 27  20 7d 29 3b 0d 0a 20 7d   ontrada' });.. }
07c0	0d 0a 20 72 65 73 2e 72  65 6e 64 65 72 28 27 65   .. res.render('e
07d0	64 69 74 4f 62 72 61 27  2c 20 7b 20 6f 62 72 61   ditObra', { obra
07e0	3a 20 6f 62 72 61 5b 30  5d 20 7d 29 3b 0d 0a 20   : obra[0] });.. 
07f0	7d 20 63 61 74 63 68 20  28 65 72 72 29 20 7b 0d   } catch (err) {.
0800	0a 20 63 6f 6e 73 6f 6c  65 2e 65 72 72 6f 72 28   . console.error(
0810	27 45 72 72 6f 20 61 6f  20 63 61 72 72 65 67 61   'Erro ao carrega
0820	72 20 70 c3 a1 67 69 6e  61 20 64 65 20 65 64 69   r p..gina de edi
0830	c3 a7 c3 a3 6f 3a 27 2c  20 65 72 72 29 3b 0d 0a   ....o:', err);..
0840	20 72 65 73 2e 73 74 61  74 75 73 28 35 30 30 29    res.status(500)
0850	2e 72 65 6e 64 65 72 28  27 65 72 72 6f 72 27 2c   .render('error',
0860	20 7b 20 6d 65 73 73 61  67 65 3a 20 27 45 72 72    { message: 'Err
0870	6f 20 69 6e 74 65 72 6e  6f 20 64 6f 20 73 65 72   o interno do ser
0880	76 69 64 6f 72 27 20 7d  29 3b 0d 0a 20 7d 0d 0a   vidor' });.. }..
0890	7d 3b 0d 0a 0d 0a 65 78  70 6f 72 74 73 2e 65 64   };....exports.ed
08a0	69 74 61 72 4f 62 72 61  20 3d 20 61 73 79 6e 63   itarObra = async
08b0	20 28 72 65 71 2c 20 72  65 73 29 20 3d 3e 20 7b    (req, res) => {
08c0	0d 0a 20 74 72 79 20 7b  0d 0a 20 63 6f 6e 73 74   .. try {.. const
08d0	20 7b 20 69 64 20 7d 20  3d 20 72 65 71 2e 70 61    { id } = req.pa
08e0	72 61 6d 73 3b 0d 0a 20  63 6f 6e 73 74 20 7b 20   rams;.. const { 
08f0	6e 6f 6d 65 2c 20 65 6e  64 65 72 65 63 6f 2c 20   nome, endereco, 
0900	63 6c 69 65 6e 74 65 2c  20 6f 72 63 61 6d 65 6e   cliente, orcamen
0910	74 6f 2c 20 64 61 74 61  5f 69 6e 69 63 69 6f 2c   to, data_inicio,
0920	20 64 61 74 61 5f 66 69  6d 2c 20 73 74 61 74 75    data_fim, statu
0930	73 20 7d 20 3d 20 72 65  71 2e 62 6f 64 79 3b 0d   s } = req.body;.
0940	0a 20 61 77 61 69 74 20  64 62 2e 65 78 65 63 75   . await db.execu
0950	74 65 28 60 55 50 44 41  54 45 20 6f 62 72 61 73   te(`UPDATE obras
0960	20 53 45 54 20 6e 6f 6d  65 20 3d 20 3f 2c 20 65    SET nome = ?, e
0970	6e 64 65 72 65 63 6f 20  3d 20 3f 2c 20 63 6c 69   ndereco = ?, cli
0980	65 6e 74 65 20 3d 20 3f  2c 20 6f 72 63 61 6d 65   ente = ?, orcame
0990	6e 74 6f 20 3d 20 3f 2c  20 64 61 74 61 5f 69 6e   nto = ?, data_in
09a0	69 63 69 6f 20 3d 20 3f  2c 20 64 61 74 61 5f 66   icio = ?, data_f
09b0	69 6d 20 3d 20 3f 2c 20  73 74 61 74 75 73 20 3d   im = ?, status =
09c0	20 3f 20 57 48 45 52 45  20 69 64 20 3d 20 3f 60    ? WHERE id = ?`
09d0	2c 20 5b 6e 6f 6d 65 2c  20 65 6e 64 65 72 65 63   , [nome, enderec
09e0	6f 2c 20 63 6c 69 65 6e  74 65 2c 20 6f 72 63 61   o, cliente, orca
09f0	6d 65 6e 74 6f 2c 20 64  61 74 61 5f 69 6e 69 63   mento, data_inic
0a00	69 6f 2c 20 64 61 74 61  5f 66 69 6d 2c 20 73 74   io, data_fim, st
0a10	61 74 75 73 2c 20 69 64  5d 29 3b 0d 0a 20 72 65   atus, id]);.. re
0a20	73 2e 72 65 64 69 72 65  63 74 28 27 2f 64 61 73   s.redirect('/das
0a30	68 62 6f 61 72 64 2f 63  6f 6e 74 72 6f 6c 65 20   hboard/controle 
0a40	67 65 72 61 6c 2f 6f 62  72 61 73 27 29 3b 0d 0a   geral/obras');..
0a50	20 7d 20 63 61 74 63 68  20 28 65 72 72 29 20 7b    } catch (err) {
0a60	0d 0a 20 63 6f 6e 73 6f  6c 65 2e 65 72 72 6f 72   .. console.error
0a70	28 27 45 72 72 6f 20 61  6f 20 65 64 69 74 61 72   ('Erro ao editar
0a80	20 6f 62 72 61 3a 27 2c  20 65 72 72 29 3b 0d 0a    obra:', err);..
0a90	20 72 65 73 2e 73 74 61  74 75 73 28 35 30 30 29    res.status(500)
0aa0	2e 72 65 6e 64 65 72 28  27 65 72 72 6f 72 27 2c   .render('error',
0ab0	20 7b 20 6d 65 73 73 61  67 65 3a 20 27 45 72 72    { message: 'Err
0ac0	6f 20 69 6e 74 65 72 6e  6f 20 64 6f 20 73 65 72   o interno do ser
0ad0	76 69 64 6f 72 27 20 7d  29 3b 0d 0a 20 7d 0d 0a   vidor' });.. }..
0ae0	7d 3b 0d 0a 0d 0a 65 78  70 6f 72 74 73 2e 65 78   };....exports.ex
0af0	63 6c 75 69 72 4f 62 72  61 20 3d 20 61 73 79 6e   cluirObra = asyn
0b00	63 20 28 72 65 71 2c 20  72 65 73 29 20 3d 3e 20   c (req, res) => 
0b10	7b 0d 0a 20 74 72 79 20  7b 0d 0a 20 63 6f 6e 73   {.. try {.. cons
0b20	74 20 7b 20 69 64 20 7d  20 3d 20 72 65 71 2e 70   t { id } = req.p
0b30	61 72 61 6d 73 3b 0d 0a  20 61 77 61 69 74 20 64   arams;.. await d
0b40	62 2e 65 78 65 63 75 74  65 28 27 44 45 4c 45 54   b.execute('DELET
0b50	45 20 46 52 4f 4d 20 6f  62 72 61 73 20 57 48 45   E FROM obras WHE
0b60	52 45 20 69 64 20 3d 20  3f 27 2c 20 5b 69 64 5d   RE id = ?', [id]
0b70	29 3b 0d 0a 20 72 65 73  2e 72 65 64 69 72 65 63   );.. res.redirec
0b80	74 28 27 2f 64 61 73 68  62 6f 61 72 64 2f 63 6f   t('/dashboard/co
0b90	6e 74 72 6f 6c 65 20 67  65 72 61 6c 2f 6f 62 72   ntrole geral/obr
0ba0	61 73 27 29 3b 0d 0a 20  7d 20 63 61 74 63 68 20   as');.. } catch 
0bb0	28 65 72 72 29 20 7b 0d  0a 20 63 6f 6e 73 6f 6c   (err) {.. consol
0bc0	65 2e 65 72 72 6f 72 28  27 45 72 72 6f 20 61 6f   e.error('Erro ao
0bd0	20 65 78 63 6c 75 69 72  20 6f 62 72 61 3a 27 2c    excluir obra:',
0be0	20 65 72 72 29 3b 0d 0a  20 72 65 73 2e 73 74 61    err);.. res.sta
0bf0	74 75 73 28 35 30 30 29  2e 72 65 6e 64 65 72 28   tus(500).render(
0c00	27 65 72 72 6f 72 27 2c  20 7b 20 6d 65 73 73 61   'error', { messa
0c10	67 65 3a 20 27 45 72 72  6f 20 69 6e 74 65 72 6e   ge: 'Erro intern
0c20	6f 20 64 6f 20 73 65 72  76 69 64 6f 72 27 20 7d   o do servidor' }
0c30	29 3b 0d 0a 20 7d 0d 0a  7d 3b 0d 0a 0d 0a 2f 2f   );.. }..};....//
0c40	20 45 53 54 4f 51 55 45  0d 0a 65 78 70 6f 72 74    ESTOQUE..export
0c50	73 2e 65 73 74 6f 71 75  65 20 3d 20 61 73 79 6e   s.estoque = asyn
0c60	63 20 28 72 65 71 2c 20  72 65 73 29 20 3d 3e 20   c (req, res) => 
0c70	7b 0d 0a 20 74 72 79 20  7b 0d 0a 20 63 6f 6e 73   {.. try {.. cons
0c80	74 20 5b 6d 61 74 65 72  69 61 69 73 5d 20 3d 20   t [materiais] = 
0c90	61 77 61 69 74 20 64 62  2e 65 78 65 63 75 74 65   await db.execute
0ca0	28 60 0d 0a 20 53 45 4c  45 43 54 20 6d 2e 2a 2c   (`.. SELECT m.*,
0cb0	20 27 27 20 61 73 20 6f  62 72 61 5f 6e 6f 6d 65    '' as obra_nome
0cc0	0d 0a 20 46 52 4f 4d 20  6d 61 74 65 72 69 61 69   .. FROM materiai
0cd0	73 20 6d 0d 0a 20 4f 52  44 45 52 20 42 59 20 6d   s m.. ORDER BY m
0ce0	2e 69 64 20 44 45 53 43  0d 0a 20 60 29 3b 0d 0a   .id DESC.. `);..
0cf0	20 2f 2f 20 42 75 73 63  61 72 20 6f 62 72 61 73    // Buscar obras
0d00	20 70 61 72 61 20 6f 20  64 72 6f 70 64 6f 77 6e    para o dropdown
0d10	0d 0a 20 63 6f 6e 73 74  20 5b 6f 62 72 61 73 5d   .. const [obras]
0d20	20 3d 20 61 77 61 69 74  20 64 62 2e 65 78 65 63    = await db.exec
0d30	75 74 65 28 27 53 45 4c  45 43 54 20 69 64 2c 20   ute('SELECT id, 
0d40	6e 6f 6d 65 5f 6f 62 72  61 20 61 73 20 6e 6f 6d   nome_obra as nom
0d50	65 20 46 52 4f 4d 20 6f  62 72 61 73 20 4f 52 44   e FROM obras ORD
0d60	45 52 20 42 59 20 6e 6f  6d 65 5f 6f 62 72 61 27   ER BY nome_obra'
0d70	29 3b 0d 0a 20 72 65 73  2e 72 65 6e 64 65 72 28   );.. res.render(
0d80	27 65 73 74 6f 71 75 65  27 2c 20 7b 20 6d 61 74   'estoque', { mat
0d90	65 72 69 61 69 73 3a 20  6d 61 74 65 72 69 61 69   eriais: materiai
0da0	73 20 7c 7c 20 5b 5d 2c  20 6f 62 72 61 73 3a 20   s || [], obras: 
0db0	6f 62 72 61 73 20 7c 7c  20 5b 5d 20 7d 29 3b 0d   obras || [] });.
0dc0	0a 20 7d 20 63 61 74 63  68 20 28 65 72 72 29 20   . } catch (err) 
0dd0	7b 0d 0a 20 63 6f 6e 73  6f 6c 65 2e 65 72 72 6f   {.. console.erro
0de0	72 28 27 45 72 72 6f 20  61 6f 20 63 61 72 72 65   r('Erro ao carre
0df0	67 61 72 20 65 73 74 6f  71 75 65 3a 27 2c 20 65   gar estoque:', e
0e00	72 72 29 3b 0d 0a 20 72  65 73 2e 73 74 61 74 75   rr);.. res.statu
0e10	73 28 35 30 30 29 2e 72  65 6e 64 65 72 28 27 65   s(500).render('e
0e20	72 72 6f 72 27 2c 20 7b  20 6d 65 73 73 61 67 65   rror', { message
0e30	3a 20 27 45 72 72 6f 20  69 6e 74 65 72 6e 6f 20   : 'Erro interno 
0e40	64 6f 20 73 65 72 76 69  64 6f 72 27 20 7d 29 3b   do servidor' });
0e50	0d 0a 20 7d 0d 0a 7d 3b  0d 0a 0d 0a 65 78 70 6f   .. }..};....expo
0e60	72 74 73 2e 63 72 69 61  72 4d 61 74 65 72 69 61   rts.criarMateria
0e70	6c 20 3d 20 61 73 79 6e  63 20 28 72 65 71 2c 20   l = async (req, 
0e80	72 65 73 29 20 3d 3e 20  7b 0d 0a 20 74 72 79 20   res) => {.. try 
0e90	7b 0d 0a 20 63 6f 6e 73  74 20 7b 20 63 6f 64 69   {.. const { codi
0ea0	67 6f 2c 20 64 65 73 63  72 69 63 61 6f 2c 20 75   go, descricao, u
0eb0	6e 69 64 61 64 65 2c 20  71 75 61 6e 74 69 64 61   nidade, quantida
0ec0	64 65 2c 20 70 72 65 63  6f 5f 6d 65 64 69 6f 2c   de, preco_medio,
0ed0	20 65 73 74 6f 71 75 65  5f 6d 69 6e 69 6d 6f 2c    estoque_minimo,
0ee0	20 6f 62 72 61 5f 69 64  20 7d 20 3d 20 72 65 71    obra_id } = req
0ef0	2e 62 6f 64 79 3b 0d 0a  20 61 77 61 69 74 20 64   .body;.. await d
0f00	62 2e 65 78 65 63 75 74  65 28 60 49 4e 53 45 52   b.execute(`INSER
0f10	54 20 49 4e 54 4f 20 6d  61 74 65 72 69 61 69 73   T INTO materiais
0f20	20 28 63 6f 64 69 67 6f  2c 20 64 65 73 63 72 69    (codigo, descri
0f30	63 61 6f 2c 20 75 6e 69  64 61 64 65 2c 20 71 75   cao, unidade, qu
0f40	61 6e 74 69 64 61 64 65  2c 20 70 72 65 63 6f 5f   antidade, preco_
0f50	6d 65 64 69 6f 2c 20 65  73 74 6f 71 75 65 5f 6d   medio, estoque_m
0f60	69 6e 69 6d 6f 2c 20 6f  62 72 61 5f 69 64 29 20   inimo, obra_id) 
0f70	56 41 4c 55 45 53 20 28  3f 2c 20 3f 2c 20 3f 2c   VALUES (?, ?, ?,
0f80	20 3f 2c 20 3f 2c 20 3f  2c 20 3f 29 60 2c 0d 0a    ?, ?, ?, ?)`,..
0f90	20 5b 63 6f 64 69 67 6f  2c 20 64 65 73 63 72 69    [codigo, descri
0fa0	63 61 6f 2c 20 75 6e 69  64 61 64 65 2c 20 71 75   cao, unidade, qu
0fb0	61 6e 74 69 64 61 64 65  2c 20 70 72 65 63 6f 5f   antidade, preco_
0fc0	6d 65 64 69 6f 2c 20 65  73 74 6f 71 75 65 5f 6d   medio, estoque_m
0fd0	69 6e 69 6d 6f 2c 20 6f  62 72 61 5f 69 64 5d 29   inimo, obra_id])
0fe0	3b 0d 0a 20 72 65 73 2e  72 65 64 69 72 65 63 74   ;.. res.redirect
0ff0	28 27 2f 64 61 73 68 62  6f 61 72 64 2f 63 6f 6e   ('/dashboard/con
1000	74 72 6f 6c 65 20 67 65  72 61 6c 2f 65 73 74 6f   trole geral/esto
1010	71 75 65 27 29 3b 0d 0a  20 7d 20 63 61 74 63 68   que');.. } catch
1020	20 28 65 72 72 29 20 7b  0d 0a 20 63 6f 6e 73 6f    (err) {.. conso
1030	6c 65 2e 65 72 72 6f 72  28 27 45 72 72 6f 20 61   le.error('Erro a
1040	6f 20 63 72 69 61 72 20  6d 61 74 65 72 69 61 6c   o criar material
1050	3a 27 2c 20 65 72 72 29  3b 0d 0a 20 72 65 73 2e   :', err);.. res.
1060	73 74 61 74 75 73 28 35  30 30 29 2e 6a 73 6f 6e   status(500).json
1070	28 7b 20 65 72 72 6f 72  3a 20 27 45 72 72 6f 20   ({ error: 'Erro 
1080	69 6e 74 65 72 6e 6f 20  64 6f 20 73 65 72 76 69   interno do servi
1090	64 6f 72 27 20 7d 29 3b  0d 0a 20 7d 0d 0a 20 7d   dor' });.. }.. }
10a0	3b 0d 0a 0d 0a 65 78 70  6f 72 74 73 2e 65 64 69   ;....exports.edi
10b0	74 61 72 4d 61 74 65 72  69 61 6c 50 61 67 65 20   tarMaterialPage 
10c0	3d 20 61 73 79 6e 63 20  28 72 65 71 2c 20 72 65   = async (req, re
10d0	73 29 20 3d 3e 20 7b 0d  0a 20 74 72 79 20 7b 0d   s) => {.. try {.
10e0	0a 20 63 6f 6e 73 74 20  7b 20 69 64 20 7d 20 3d   . const { id } =
10f0	20 72 65 71 2e 70 61 72  61 6d 73 3b 0d 0a 20 63    req.params;.. c
1100	6f 6e 73 74 20 5b 6d 61  74 65 72 69 61 6c 5d 20   onst [material] 
1110	3d 20 61 77 61 69 74 20  64 62 2e 65 78 65 63 75   = await db.execu
1120	74 65 28 27 53 45 4c 45  43 54 20 2a 20 46 52 4f   te('SELECT * FRO
1130	4d 20 6d 61 74 65 72 69  61 69 73 20 57 48 45 52   M materiais WHER
1140	45 20 69 64 20 3d 20 3f  27 2c 20 5b 69 64 5d 29   E id = ?', [id])
1150	3b 0d 0a 20 69 66 20 28  21 6d 61 74 65 72 69 61   ;.. if (!materia
1160	6c 5b 30 5d 29 20 7b 0d  0a 20 72 65 74 75 72 6e   l[0]) {.. return
1170	20 72 65 73 2e 73 74 61  74 75 73 28 34 30 34 29    res.status(404)
1180	2e 72 65 6e 64 65 72 28  27 65 72 72 6f 72 27 2c   .render('error',
1190	20 7b 20 6d 65 73 73 61  67 65 3a 20 27 4d 61 74    { message: 'Mat
11a0	65 72 69 61 6c 20 6e c3  a3 6f 20 65 6e 63 6f 6e   erial n..o encon
11b0	74 72 61 64 6f 27 20 7d  29 3b 0d 0a 20 7d 0d 0a   trado' });.. }..
11c0	20 2f 2f 20 42 75 73 63  61 72 20 6f 62 72 61 73    // Buscar obras
11d0	20 70 61 72 61 20 6f 20  64 72 6f 70 64 6f 77 6e    para o dropdown
11e0	0d 0a 20 63 6f 6e 73 74  20 5b 6f 62 72 61 73 5d   .. const [obras]
11f0	20 3d 20 61 77 61 69 74  20 64 62 2e 65 78 65 63    = await db.exec
1200	75 74 65 28 27 53 45 4c  45 43 54 20 69 64 2c 20   ute('SELECT id, 
1210	6e 6f 6d 65 20 46 52 4f  4d 20 6f 62 72 61 73 20   nome FROM obras 
1220	4f 52 44 45 52 20 42 59  20 6e 6f 6d 65 27 29 3b   ORDER BY nome');
1230	0d 0a 20 72 65 73 2e 72  65 6e 64 65 72 28 27 65   .. res.render('e
1240	64 69 74 4d 61 74 65 72  69 61 6c 27 2c 20 7b 20   ditMaterial', { 
1250	6d 61 74 65 72 69 61 6c  3a 20 6d 61 74 65 72 69   material: materi
1260	61 6c 5b 30 5d 2c 20 6f  62 72 61 73 3a 20 6f 62   al[0], obras: ob
1270	72 61 73 20 7c 7c 20 5b  5d 20 7d 29 3b 0d 0a 20   ras || [] });.. 
1280	7d 20 63 61 74 63 68 20  28 65 72 72 29 20 7b 0d   } catch (err) {.
1290	0a 20 63 6f 6e 73 6f 6c  65 2e 65 72 72 6f 72 28   . console.error(
12a0	27 45 72 72 6f 20 61 6f  20 63 61 72 72 65 67 61   'Erro ao carrega
12b0	72 20 70 c3 a1 67 69 6e  61 20 64 65 20 65 64 69   r p..gina de edi
12c0	c3 a7 c3 a3 6f 3a 27 2c  20 65 72 72 29 3b 0d 0a   ....o:', err);..
12d0	20 72 65 73 2e 73 74 61  74 75 73 28 35 30 30 29    res.status(500)
12e0	2e 72 65 6e 64 65 72 28  27 65 72 72 6f 72 27 2c   .render('error',
12f0	20 7b 20 6d 65 73 73 61  67 65 3a 20 27 45 72 72    { message: 'Err
1300	6f 20 69 6e 74 65 72 6e  6f 20 64 6f 20 73 65 72   o interno do ser
1310	76 69 64 6f 72 27 20 7d  29 3b 0d 0a 20 7d 0d 0a   vidor' });.. }..
1320	7d 3b 0d 0a 0d 0a 65 78  70 6f 72 74 73 2e 65 64   };....exports.ed
1330	69 74 61 72 4d 61 74 65  72 69 61 6c 20 3d 20 61   itarMaterial = a
1340	73 79 6e 63 20 28 72 65  71 2c 20 72 65 73 29 20   sync (req, res) 
1350	3d 3e 20 7b 0d 0a 20 74  72 79 20 7b 0d 0a 20 63   => {.. try {.. c
1360	6f 6e 73 74 20 7b 20 69  64 20 7d 20 3d 20 72 65   onst { id } = re
1370	71 2e 70 61 72 61 6d 73  3b 0d 0a 20 63 6f 6e 73   q.params;.. cons
1380	74 20 7b 20 63 6f 64 69  67 6f 2c 20 64 65 73 63   t { codigo, desc
1390	72 69 63 61 6f 2c 20 75  6e 69 64 61 64 65 2c 20   ricao, unidade, 
13a0	71 75 61 6e 74 69 64 61  64 65 2c 20 70 72 65 63   quantidade, prec
13b0	6f 5f 6d 65 64 69 6f 2c  20 65 73 74 6f 71 75 65   o_medio, estoque
13c0	5f 6d 69 6e 69 6d 6f 2c  20 6f 62 72 61 5f 69 64   _minimo, obra_id
13d0	20 7d 20 3d 20 72 65 71  2e 62 6f 64 79 3b 0d 0a    } = req.body;..
13e0	20 61 77 61 69 74 20 64  62 2e 65 78 65 63 75 74    await db.execut
13f0	65 28 60 55 50 44 41 54  45 20 6d 61 74 65 72 69   e(`UPDATE materi
1400	61 69 73 20 53 45 54 20  63 6f 64 69 67 6f 20 3d   ais SET codigo =
1410	20 3f 2c 20 64 65 73 63  72 69 63 61 6f 20 3d 20    ?, descricao = 
1420	3f 2c 20 75 6e 69 64 61  64 65 20 3d 20 3f 2c 20   ?, unidade = ?, 
1430	71 75 61 6e 74 69 64 61  64 65 20 3d 20 3f 2c 20   quantidade = ?, 
1440	70 72 65 63 6f 5f 6d 65  64 69 6f 20 3d 20 3f 2c   preco_medio = ?,
1450	20 65 73 74 6f 71 75 65  5f 6d 69 6e 69 6d 6f 20    estoque_minimo 
1460	3d 20 3f 2c 20 6f 62 72  61 5f 69 64 20 3d 20 3f   = ?, obra_id = ?
1470	20 57 48 45 52 45 20 69  64 20 3d 20 3f 60 2c 0d    WHERE id = ?`,.
1480	0a 20 5b 63 6f 64 69 67  6f 2c 20 64 65 73 63 72   . [codigo, descr
1490	69 63 61 6f 2c 20 75 6e  69 64 61 64 65 2c 20 71   icao, unidade, q
14a0	75 61 6e 74 69 64 61 64  65 2c 20 70 72 65 63 6f   uantidade, preco
14b0	5f 6d 65 64 69 6f 2c 20  65 73 74 6f 71 75 65 5f   _medio, estoque_
14c0	6d 69 6e 69 6d 6f 2c 20  6f 62 72 61 5f 69 64 2c   minimo, obra_id,
14d0	20 69 64 5d 29 3b 0d 0a  20 72 65 73 2e 72 65 64    id]);.. res.red
14e0	69 72 65 63 74 28 27 2f  64 61 73 68 62 6f 61 72   irect('/dashboar
14f0	64 2f 63 6f 6e 74 72 6f  6c 65 20 67 65 72 61 6c   d/controle geral
1500	2f 65 73 74 6f 71 75 65  27 29 3b 0d 0a 20 7d 20   /estoque');.. } 
1510	63 61 74 63 68 20 28 65  72 72 29 20 7b 0d 0a 20   catch (err) {.. 
1520	63 6f 6e 73 6f 6c 65 2e  65 72 72 6f 72 28 27 45   console.error('E
1530	72 72 6f 20 61 6f 20 65  64 69 74 61 72 20 6d 61   rro ao editar ma
1540	74 65 72 69 61 6c 3a 27  2c 20 65 72 72 29 3b 0d   terial:', err);.
1550	0a 20 72 65 73 2e 73 74  61 74 75 73 28 35 30 30   . res.status(500
1560	29 2e 72 65 6e 64 65 72  28 27 65 72 72 6f 72 27   ).render('error'
1570	2c 20 7b 20 6d 65 73 73  61 67 65 3a 20 27 45 72   , { message: 'Er
1580	72 6f 20 69 6e 74 65 72  6e 6f 20 64 6f 20 73 65   ro interno do se
1590	72 76 69 64 6f 72 27 20  7d 29 3b 0d 0a 20 7d 0d   rvidor' });.. }.
15a0	0a 7d 3b 0d 0a 0d 0a 65  78 70 6f 72 74 73 2e 65   .};....exports.e
15b0	78 63 6c 75 69 72 4d 61  74 65 72 69 61 6c 20 3d   xcluirMaterial =
15c0	20 61 73 79 6e 63 20 28  72 65 71 2c 20 72 65 73    async (req, res
15d0	29 20 3d 3e 20 7b 0d 0a  20 74 72 79 20 7b 0d 0a   ) => {.. try {..
15e0	20 63 6f 6e 73 74 20 7b  20 69 64 20 7d 20 3d 20    const { id } = 
15f0	72 65 71 2e 70 61 72 61  6d 73 3b 0d 0a 20 61 77   req.params;.. aw
1600	61 69 74 20 64 62 2e 65  78 65 63 75 74 65 28 27   ait db.execute('
1610	44 45 4c 45 54 45 20 46  52 4f 4d 20 6d 61 74 65   DELETE FROM mate
1620	72 69 61 69 73 20 57 48  45 52 45 20 69 64 20 3d   riais WHERE id =
1630	20 3f 27 2c 20 5b 69 64  5d 29 3b 0d 0a 20 72 65    ?', [id]);.. re
1640	73 2e 72 65 64 69 72 65  63 74 28 27 2f 64 61 73   s.redirect('/das
1650	68 62 6f 61 72 64 2f 63  6f 6e 74 72 6f 6c 65 20   hboard/controle 
1660	67 65 72 61 6c 2f 65 73  74 6f 71 75 65 27 29 3b   geral/estoque');
1670	0d 0a 20 7d 20 63 61 74  63 68 20 28 65 72 72 29   .. } catch (err)
1680	20 7b 0d 0a 20 63 6f 6e  73 6f 6c 65 2e 65 72 72    {.. console.err
1690	6f 72 28 27 45 72 72 6f  20 61 6f 20 65 78 63 6c   or('Erro ao excl
16a0	75 69 72 20 6d 61 74 65  72 69 61 6c 3a 27 2c 20   uir material:', 
16b0	65 72 72 29 3b 0d 0a 20  72 65 73 2e 73 74 61 74   err);.. res.stat
16c0	75 73 28 35 30 30 29 2e  72 65 6e 64 65 72 28 27   us(500).render('
16d0	65 72 72 6f 72 27 2c 20  7b 20 6d 65 73 73 61 67   error', { messag
16e0	65 3a 20 27 45 72 72 6f  20 69 6e 74 65 72 6e 6f   e: 'Erro interno
16f0	20 64 6f 20 73 65 72 76  69 64 6f 72 27 20 7d 29    do servidor' })
1700	3b 0d 0a 20 7d 0d 0a 7d  3b 0d 0a 0d 0a 2f 2f 20   ;.. }..};....// 
1710	45 51 55 49 50 45 53 0d  0a 65 78 70 6f 72 74 73   EQUIPES..exports
1720	2e 65 71 75 69 70 65 73  20 3d 20 61 73 79 6e 63   .equipes = async
1730	20 28 72 65 71 2c 20 72  65 73 29 20 3d 3e 20 7b    (req, res) => {
1740	0d 0a 20 74 72 79 20 7b  0d 0a 20 2f 2f 20 42 75   .. try {.. // Bu
1750	73 63 61 72 20 66 75 6e  63 69 6f 6e c3 a1 72 69   scar funcion..ri
1760	6f 73 20 63 6f 6d 20 69  6e 66 6f 72 6d 61 c3 a7   os com informa..
1770	c3 b5 65 73 20 64 61 20  6f 62 72 61 0d 0a 20 63   ..es da obra.. c
1780	6f 6e 73 74 20 5b 66 75  6e 63 69 6f 6e 61 72 69   onst [funcionari
1790	6f 73 5d 20 3d 20 61 77  61 69 74 20 64 62 2e 65   os] = await db.e
17a0	78 65 63 75 74 65 28 60  0d 0a 20 53 45 4c 45 43   xecute(`.. SELEC
17b0	54 20 66 2e 2a 2c 20 6f  2e 6e 6f 6d 65 5f 6f 62   T f.*, o.nome_ob
17c0	72 61 20 61 73 20 6f 62  72 61 5f 6e 6f 6d 65 0d   ra as obra_nome.
17d0	0a 20 46 52 4f 4d 20 66  75 6e 63 69 6f 6e 61 72   . FROM funcionar
17e0	69 6f 73 20 66 0d 0a 20  4c 45 46 54 20 4a 4f 49   ios f.. LEFT JOI
17f0	4e 20 6f 62 72 61 73 20  6f 20 4f 4e 20 66 2e 6f   N obras o ON f.o
1800	62 72 61 5f 69 64 20 3d  20 6f 2e 69 64 0d 0a 20   bra_id = o.id.. 
1810	4f 52 44 45 52 20 42 59  20 66 2e 69 64 20 44 45   ORDER BY f.id DE
1820	53 43 0d 0a 20 60 29 3b  0d 0a 0d 0a 20 2f 2f 20   SC.. `);.... // 
1830	42 75 73 63 61 72 20 6f  62 72 61 73 20 70 61 72   Buscar obras par
1840	61 20 6f 20 64 72 6f 70  64 6f 77 6e 0d 0a 20 63   a o dropdown.. c
1850	6f 6e 73 74 20 5b 6f 62  72 61 73 5d 20 3d 20 61   onst [obras] = a
1860	77 61 69 74 20 64 62 2e  65 78 65 63 75 74 65 28   wait db.execute(
1870	27 53 45 4c 45 43 54 20  69 64 2c 20 6e 6f 6d 65   'SELECT id, nome
1880	5f 6f 62 72 61 20 61 73  20 6e 6f 6d 65 20 46 52   _obra as nome FR
1890	4f 4d 20 6f 62 72 61 73  20 4f 52 44 45 52 20 42   OM obras ORDER B
18a0	59 20 6e 6f 6d 65 5f 6f  62 72 61 27 29 3b 0d 0a   Y nome_obra');..
18b0	20 72 65 73 2e 72 65 6e  64 65 72 28 27 65 71 75    res.render('equ
18c0	69 70 65 73 27 2c 20 7b  20 66 75 6e 63 69 6f 6e   ipes', { funcion
18d0	61 72 69 6f 73 3a 20 66  75 6e 63 69 6f 6e 61 72   arios: funcionar
18e0	69 6f 73 20 7c 7c 20 5b  5d 2c 20 6f 62 72 61 73   ios || [], obras
18f0	3a 20 6f 62 72 61 73 20  7c 7c 20 5b 5d 20 7d 29   : obras || [] })
1900	3b 0d 0a 20 7d 20 63 61  74 63 68 20 28 65 72 72   ;.. } catch (err
1910	29 20 7b 0d 0a 20 63 6f  6e 73 6f 6c 65 2e 65 72   ) {.. console.er
1920	72 6f 72 28 27 45 72 72  6f 20 61 6f 20 63 61 72   ror('Erro ao car
1930	72 65 67 61 72 20 65 71  75 69 70 65 73 3a 27 2c   regar equipes:',
1940	20 65 72 72 29 3b 0d 0a  20 72 65 73 2e 73 74 61    err);.. res.sta
1950	74 75 73 28 35 30 30 29  2e 72 65 6e 64 65 72 28   tus(500).render(
1960	27 65 72 72 6f 72 27 2c  20 7b 20 6d 65 73 73 61   'error', { messa
1970	67 65 3a 20 27 45 72 72  6f 20 69 6e 74 65 72 6e   ge: 'Erro intern
1980	6f 20 64 6f 20 73 65 72  76 69 64 6f 72 27 20 7d   o do servidor' }
1990	29 3b 0d 0a 20 7d 0d 0a  7d 3b 0d 0a 0d 0a 65 78   );.. }..};....ex
19a0	70 6f 72 74 73 2e 63 72  69 61 72 46 75 6e 63 69   ports.criarFunci
19b0	6f 6e 61 72 69 6f 20 3d  20 61 73 79 6e 63 20 28   onario = async (
19c0	72 65 71 2c 20 72 65 73  29 20 3d 3e 20 7b 0d 0a   req, res) => {..
19d0	20 74 72 79 20 7b 0d 0a  20 63 6f 6e 73 74 20 7b    try {.. const {
19e0	20 6e 6f 6d 65 2c 20 66  75 6e 63 61 6f 2c 20 73    nome, funcao, s
19f0	61 6c 61 72 69 6f 2c 20  6f 62 72 61 5f 69 64 20   alario, obra_id 
1a00	7d 20 3d 20 72 65 71 2e  62 6f 64 79 3b 0d 0a 20   } = req.body;.. 
1a10	61 77 61 69 74 20 64 62  2e 65 78 65 63 75 74 65   await db.execute
1a20	28 60 49 4e 53 45 52 54  20 49 4e 54 4f 20 66 75   (`INSERT INTO fu
1a30	6e 63 69 6f 6e 61 72 69  6f 73 20 28 6e 6f 6d 65   ncionarios (nome
1a40	2c 20 66 75 6e 63 61 6f  2c 20 73 61 6c 61 72 69   , funcao, salari
1a50	6f 2c 20 6f 62 72 61 5f  69 64 29 20 56 41 4c 55   o, obra_id) VALU
1a60	45 53 20 28 3f 2c 20 3f  2c 20 3f 2c 20 3f 29 60   ES (?, ?, ?, ?)`
1a70	2c 0d 0a 20 5b 6e 6f 6d  65 2c 20 66 75 6e 63 61   ,.. [nome, funca
1a80	6f 2c 20 73 61 6c 61 72  69 6f 2c 20 6f 62 72 61   o, salario, obra
1a90	5f 69 64 20 7c 7c 20 6e  75 6c 6c 5d 29 3b 0d 0a   _id || null]);..
1aa0	20 72 65 73 2e 72 65 64  69 72 65 63 74 28 27 2f    res.redirect('/
1ab0	64 61 73 68 62 6f 61 72  64 2f 63 6f 6e 74 72 6f   dashboard/contro
1ac0	6c 65 20 67 65 72 61 6c  2f 65 71 75 69 70 65 73   le geral/equipes
1ad0	27 29 3b 0d 0a 20 7d 20  63 61 74 63 68 20 28 65   ');.. } catch (e
1ae0	72 72 29 20 7b 0d 0a 20  63 6f 6e 73 6f 6c 65 2e   rr) {.. console.
1af0	65 72 72 6f 72 28 27 45  72 72 6f 20 61 6f 20 63   error('Erro ao c
1b00	72 69 61 72 20 66 75 6e  63 69 6f 6e c3 a1 72 69   riar funcion..ri
1b10	6f 3a 27 2c 20 65 72 72  29 3b 0d 0a 20 72 65 73   o:', err);.. res
1b20	2e 73 74 61 74 75 73 28  35 30 30 29 2e 6a 73 6f   .status(500).jso
1b30	6e 28 7b 20 65 72 72 6f  72 3a 20 27 45 72 72 6f   n({ error: 'Erro
1b40	20 69 6e 74 65 72 6e 6f  20 64 6f 20 73 65 72 76    interno do serv
1b50	69 64 6f 72 27 20 7d 29  3b 0d 0a 20 7d 0d 0a 20   idor' });.. }.. 
1b60	7d 3b 0d 0a 0d 0a 65 78  70 6f 72 74 73 2e 65 64   };....exports.ed
1b70	69 74 61 72 46 75 6e 63  69 6f 6e 61 72 69 6f 20   itarFuncionario 
1b80	3d 20 61 73 79 6e 63 20  28 72 65 71 2c 20 72 65   = async (req, re
1b90	73 29 20 3d 3e 20 7b 0d  0a 20 74 72 79 20 7b 0d   s) => {.. try {.
1ba0	0a 20 63 6f 6e 73 74 20  7b 20 69 64 2c 20 6e 6f   . const { id, no
1bb0	6d 65 2c 20 66 75 6e 63  61 6f 2c 20 73 61 6c 61   me, funcao, sala
1bc0	72 69 6f 2c 20 6f 62 72  61 5f 69 64 20 7d 20 3d   rio, obra_id } =
1bd0	20 72 65 71 2e 62 6f 64  79 3b 0d 0a 20 61 77 61    req.body;.. awa
1be0	69 74 20 64 62 2e 65 78  65 63 75 74 65 28 60 55   it db.execute(`U
1bf0	50 44 41 54 45 20 66 75  6e 63 69 6f 6e 61 72 69   PDATE funcionari
1c00	6f 73 20 53 45 54 20 6e  6f 6d 65 20 3d 20 3f 2c   os SET nome = ?,
1c10	20 66 75 6e 63 61 6f 20  3d 20 3f 2c 20 73 61 6c    funcao = ?, sal
1c20	61 72 69 6f 20 3d 20 3f  2c 20 6f 62 72 61 5f 69   ario = ?, obra_i
1c30	64 20 3d 20 3f 20 57 48  45 52 45 20 69 64 20 3d   d = ? WHERE id =
1c40	20 3f 60 2c 0d 0a 20 5b  6e 6f 6d 65 2c 20 66 75    ?`,.. [nome, fu
1c50	6e 63 61 6f 2c 20 73 61  6c 61 72 69 6f 2c 20 6f   ncao, salario, o
1c60	62 72 61 5f 69 64 20 7c  7c 20 6e 75 6c 6c 2c 20   bra_id || null, 
1c70	69 64 5d 29 3b 0d 0a 20  72 65 73 2e 72 65 64 69   id]);.. res.redi
1c80	72 65 63 74 28 27 2f 64  61 73 68 62 6f 61 72 64   rect('/dashboard
1c90	2f 63 6f 6e 74 72 6f 6c  65 20 67 65 72 61 6c 2f   /controle geral/
1ca0	65 71 75 69 70 65 73 27  29 3b 0d 0a 20 7d 20 63   equipes');.. } c
1cb0	61 74 63 68 20 28 65 72  72 29 20 7b 0d 0a 20 63   atch (err) {.. c
1cc0	6f 6e 73 6f 6c 65 2e 65  72 72 6f 72 28 27 45 72   onsole.error('Er
1cd0	72 6f 20 61 6f 20 65 64  69 74 61 72 20 66 75 6e   ro ao editar fun
1ce0	63 69 6f 6e c3 a1 72 69  6f 3a 27 2c 20 65 72 72   cion..rio:', err
1cf0	29 3b 0d 0a 20 72 65 73  2e 73 74 61 74 75 73 28   );.. res.status(
1d00	35 30 30 29 2e 6a 73 6f  6e 28 7b 20 65 72 72 6f   500).json({ erro
1d10	72 3a 20 27 45 72 72 6f  20 69 6e 74 65 72 6e 6f   r: 'Erro interno
1d20	20 64 6f 20 73 65 72 76  69 64 6f 72 27 20 7d 29    do servidor' })
1d30	3b 0d 0a 20 7d 0d 0a 20  7d 3b 0d 0a 0d 0a 2f 2f   ;.. }.. };....//
1d40	20 46 49 4e 41 4e 43 45  49 52 4f 0d 0a 65 78 70    FINANCEIRO..exp
1d50	6f 72 74 73 2e 66 69 6e  61 6e 63 65 69 72 6f 20   orts.financeiro 
1d60	3d 20 61 73 79 6e 63 20  28 72 65 71 2c 20 72 65   = async (req, re
1d70	73 29 20 3d 3e 20 7b 0d  0a 20 74 72 79 20 7b 0d   s) => {.. try {.
1d80	0a 20 63 6f 6e 73 74 20  5b 66 69 6e 61 6e 63 65   . const [finance
1d90	69 72 6f 5d 20 3d 20 61  77 61 69 74 20 64 62 2e   iro] = await db.
1da0	65 78 65 63 75 74 65 28  60 0d 0a 20 53 45 4c 45   execute(`.. SELE
1db0	43 54 20 66 2e 2a 2c 20  6f 2e 6e 6f 6d 65 5f 6f   CT f.*, o.nome_o
1dc0	62 72 61 20 61 73 20 6f  62 72 61 5f 6e 6f 6d 65   bra as obra_nome
1dd0	0d 0a 20 46 52 4f 4d 20  66 69 6e 61 6e 63 65 69   .. FROM financei
1de0	72 6f 20 66 0d 0a 20 4c  45 46 54 20 4a 4f 49 4e   ro f.. LEFT JOIN
1df0	20 6f 62 72 61 73 20 6f  20 4f 4e 20 66 2e 6f 62    obras o ON f.ob
1e00	72 61 5f 69 64 20 3d 20  6f 2e 69 64 0d 0a 20 4f   ra_id = o.id.. O
1e10	52 44 45 52 20 42 59 20  66 2e 69 64 20 44 45 53   RDER BY f.id DES
1e20	43 0d 0a 20 60 29 3b 0d  0a 20 2f 2f 20 42 75 73   C.. `);.. // Bus
1e30	63 61 72 20 6f 62 72 61  73 20 70 61 72 61 20 6f   car obras para o
1e40	20 64 72 6f 70 64 6f 77  6e 0d 0a 20 63 6f 6e 73    dropdown.. cons
1e50	74 20 5b 6f 62 72 61 73  5d 20 3d 20 61 77 61 69   t [obras] = awai
1e60	74 20 64 62 2e 65 78 65  63 75 74 65 28 27 53 45   t db.execute('SE
1e70	4c 45 43 54 20 69 64 2c  20 6e 6f 6d 65 5f 6f 62   LECT id, nome_ob
1e80	72 61 20 61 73 20 6e 6f  6d 65 20 46 52 4f 4d 20   ra as nome FROM 
1e90	6f 62 72 61 73 20 4f 52  44 45 52 20 42 59 20 6e   obras ORDER BY n
1ea0	6f 6d 65 5f 6f 62 72 61  27 29 3b 0d 0a 20 72 65   ome_obra');.. re
1eb0	73 2e 72 65 6e 64 65 72  28 27 66 69 6e 61 6e 63   s.render('financ
1ec0	65 69 72 6f 27 2c 20 7b  20 66 69 6e 61 6e 63 65   eiro', { finance
1ed0	69 72 6f 3a 20 66 69 6e  61 6e 63 65 69 72 6f 20   iro: financeiro 
1ee0	7c 7c 20 5b 5d 2c 20 6f  62 72 61 73 3a 20 6f 62   || [], obras: ob
1ef0	72 61 73 20 7c 7c 20 5b  5d 20 7d 29 3b 0d 0a 20   ras || [] });.. 
1f00	7d 20 63 61 74 63 68 20  28 65 72 72 29 20 7b 0d   } catch (err) {.
1f10	0a 20 63 6f 6e 73 6f 6c  65 2e 65 72 72 6f 72 28   . console.error(
1f20	27 45 72 72 6f 20 61 6f  20 63 61 72 72 65 67 61   'Erro ao carrega
1f30	72 20 66 69 6e 61 6e 63  65 69 72 6f 3a 27 2c 20   r financeiro:', 
1f40	65 72 72 29 3b 0d 0a 20  72 65 73 2e 73 74 61 74   err);.. res.stat
1f50	75 73 28 35 30 30 29 2e  72 65 6e 64 65 72 28 27   us(500).render('
1f60	65 72 72 6f 72 27 2c 20  7b 20 6d 65 73 73 61 67   error', { messag
1f70	65 3a 20 27 45 72 72 6f  20 69 6e 74 65 72 6e 6f   e: 'Erro interno
1f80	20 64 6f 20 73 65 72 76  69 64 6f 72 27 20 7d 29    do servidor' })
1f90	3b 0d 0a 20 7d 0d 0a 7d  3b 0d 0a 0d 0a 65 78 70   ;.. }..};....exp
1fa0	6f 72 74 73 2e 63 72 69  61 72 46 69 6e 61 6e 63   orts.criarFinanc
1fb0	65 69 72 6f 20 3d 20 61  73 79 6e 63 20 28 72 65   eiro = async (re
1fc0	71 2c 20 72 65 73 29 20  3d 3e 20 7b 0d 0a 20 74   q, res) => {.. t
1fd0	72 79 20 7b 0d 0a 20 63  6f 6e 73 74 20 7b 20 74   ry {.. const { t
1fe0	69 70 6f 2c 20 64 65 73  63 72 69 63 61 6f 2c 20   ipo, descricao, 
1ff0	76 61 6c 6f 72 2c 20 64  61 74 61 2c 20 6f 62 72   valor, data, obr
2000	61 5f 69 64 20 7d 20 3d  20 72 65 71 2e 62 6f 64   a_id } = req.bod
2010	79 3b 0d 0a 20 61 77 61  69 74 20 64 62 2e 65 78   y;.. await db.ex
2020	65 63 75 74 65 28 60 49  4e 53 45 52 54 20 49 4e   ecute(`INSERT IN
2030	54 4f 20 66 69 6e 61 6e  63 65 69 72 6f 20 28 74   TO financeiro (t
2040	69 70 6f 2c 20 64 65 73  63 72 69 63 61 6f 2c 20   ipo, descricao, 
2050	76 61 6c 6f 72 2c 20 64  61 74 61 2c 20 6f 62 72   valor, data, obr
2060	61 5f 69 64 29 20 56 41  4c 55 45 53 20 28 3f 2c   a_id) VALUES (?,
2070	20 3f 2c 20 3f 2c 20 3f  2c 20 3f 29 60 2c 0d 0a    ?, ?, ?, ?)`,..
2080	20 5b 74 69 70 6f 2c 20  64 65 73 63 72 69 63 61    [tipo, descrica
2090	6f 2c 20 76 61 6c 6f 72  2c 20 64 61 74 61 2c 20   o, valor, data, 
20a0	6f 62 72 61 5f 69 64 5d  29 3b 0d 0a 20 72 65 73   obra_id]);.. res
20b0	2e 72 65 64 69 72 65 63  74 28 27 2f 64 61 73 68   .redirect('/dash
20c0	62 6f 61 72 64 2f 63 6f  6e 74 72 6f 6c 65 20 67   board/controle g
20d0	65 72 61 6c 2f 66 69 6e  61 6e 63 65 69 72 6f 27   eral/financeiro'
20e0	29 3b 0d 0a 20 7d 20 63  61 74 63 68 20 28 65 72   );.. } catch (er
20f0	72 29 20 7b 0d 0a 20 63  6f 6e 73 6f 6c 65 2e 65   r) {.. console.e
2100	72 72 6f 72 28 27 45 72  72 6f 20 61 6f 20 63 72   rror('Erro ao cr
2110	69 61 72 20 74 72 61 6e  73 61 c3 a7 c3 a3 6f 20   iar transa....o 
2120	66 69 6e 61 6e 63 65 69  72 61 3a 27 2c 20 65 72   financeira:', er
2130	72 29 3b 0d 0a 20 72 65  73 2e 73 74 61 74 75 73   r);.. res.status
2140	28 35 30 30 29 2e 6a 73  6f 6e 28 7b 20 65 72 72   (500).json({ err
2150	6f 72 3a 20 27 45 72 72  6f 20 69 6e 74 65 72 6e   or: 'Erro intern
2160	6f 20 64 6f 20 73 65 72  76 69 64 6f 72 27 20 7d   o do servidor' }
2170	29 3b 0d 0a 20 7d 0d 0a  20 7d 3b 0d 0a 0d 0a 65   );.. }.. };....e
2180	78 70 6f 72 74 73 2e 65  78 63 6c 75 69 72 46 69   xports.excluirFi
2190	6e 61 6e 63 65 69 72 6f  20 3d 20 61 73 79 6e 63   nanceiro = async
21a0	20 28 72 65 71 2c 20 72  65 73 29 20 3d 3e 20 7b    (req, res) => {
21b0	0d 0a 20 74 72 79 20 7b  0d 0a 20 63 6f 6e 73 74   .. try {.. const
21c0	20 7b 20 69 64 20 7d 20  3d 20 72 65 71 2e 70 61    { id } = req.pa
21d0	72 61 6d 73 3b 0d 0a 20  61 77 61 69 74 20 64 62   rams;.. await db
21e0	2e 65 78 65 63 75 74 65  28 27 44 45 4c 45 54 45   .execute('DELETE
21f0	20 46 52 4f 4d 20 66 69  6e 61 6e 63 65 69 72 6f    FROM financeiro
2200	20 57 48 45 52 45 20 69  64 20 3d 20 3f 27 2c 20    WHERE id = ?', 
2210	5b 69 64 5d 29 3b 0d 0a  20 72 65 73 2e 72 65 64   [id]);.. res.red
2220	69 72 65 63 74 28 27 2f  64 61 73 68 62 6f 61 72   irect('/dashboar
2230	64 2f 63 6f 6e 74 72 6f  6c 65 20 67 65 72 61 6c   d/controle geral
2240	2f 66 69 6e 61 6e 63 65  69 72 6f 27 29 3b 0d 0a   /financeiro');..
2250	20 7d 20 63 61 74 63 68  20 28 65 72 72 29 20 7b    } catch (err) {
2260	0d 0a 20 63 6f 6e 73 6f  6c 65 2e 65 72 72 6f 72   .. console.error
2270	28 27 45 72 72 6f 20 61  6f 20 65 78 63 6c 75 69   ('Erro ao exclui
2280	72 20 74 72 61 6e 73 61  c3 a7 c3 a3 6f 20 66 69   r transa....o fi
2290	6e 61 6e 63 65 69 72 61  3a 27 2c 20 65 72 72 29   nanceira:', err)
22a0	3b 0d 0a 20 72 65 73 2e  73 74 61 74 75 73 28 35   ;.. res.status(5
22b0	30 30 29 2e 72 65 6e 64  65 72 28 27 65 72 72 6f   00).render('erro
22c0	72 27 2c 20 7b 20 6d 65  73 73 61 67 65 3a 20 27   r', { message: '
22d0	45 72 72 6f 20 69 6e 74  65 72 6e 6f 20 64 6f 20   Erro interno do 
22e0	73 65 72 76 69 64 6f 72  27 20 7d 29 3b 0d 0a 20   servidor' });.. 
22f0	7d 0d 0a 7d 3b 0d 0a 0d  0a 2f 2f 20 43 4f 4d 55   }..};....// COMU
2300	4e 49 43 41 c3 87 c3 83  4f 0d 0a 65 78 70 6f 72   NICA....O..expor
2310	74 73 2e 63 6f 6d 75 6e  69 63 61 63 61 6f 20 3d   ts.comunicacao =
2320	20 61 73 79 6e 63 20 28  72 65 71 2c 20 72 65 73    async (req, res
2330	29 20 3d 3e 20 7b 0d 0a  20 74 72 79 20 7b 0d 0a   ) => {.. try {..
2340	20 63 6f 6e 73 74 20 5b  6d 65 6e 73 61 67 65 6e    const [mensagen
2350	73 5d 20 3d 20 61 77 61  69 74 20 64 62 2e 65 78   s] = await db.ex
2360	65 63 75 74 65 28 60 0d  0a 20 53 45 4c 45 43 54   ecute(`.. SELECT
2370	20 6d 2e 2a 2c 20 6f 2e  6e 6f 6d 65 5f 6f 62 72    m.*, o.nome_obr
2380	61 20 61 73 20 6f 62 72  61 5f 6e 6f 6d 65 0d 0a   a as obra_nome..
2390	20 46 52 4f 4d 20 6d 65  6e 73 61 67 65 6e 73 20    FROM mensagens 
23a0	6d 0d 0a 20 4c 45 46 54  20 4a 4f 49 4e 20 6f 62   m.. LEFT JOIN ob
23b0	72 61 73 20 6f 20 4f 4e  20 6d 2e 6f 62 72 61 5f   ras o ON m.obra_
23c0	69 64 20 3d 20 6f 2e 69  64 0d 0a 20 4f 52 44 45   id = o.id.. ORDE
23d0	52 20 42 59 20 6d 2e 69  64 20 44 45 53 43 0d 0a   R BY m.id DESC..
23e0	20 60 29 3b 0d 0a 20 2f  2f 20 42 75 73 63 61 72    `);.. // Buscar
23f0	20 6f 62 72 61 73 20 70  61 72 61 20 6f 20 64 72    obras para o dr
2400	6f 70 64 6f 77 6e 0d 0a  20 63 6f 6e 73 74 20 5b   opdown.. const [
2410	6f 62 72 61 73 5d 20 3d  20 61 77 61 69 74 20 64   obras] = await d
2420	62 2e 65 78 65 63 75 74  65 28 27 53 45 4c 45 43   b.execute('SELEC
2430	54 20 69 64 2c 20 6e 6f  6d 65 5f 6f 62 72 61 20   T id, nome_obra 
2440	61 73 20 6e 6f 6d 65 20  46 52 4f 4d 20 6f 62 72   as nome FROM obr
2450	61 73 20 4f 52 44 45 52  20 42 59 20 6e 6f 6d 65   as ORDER BY nome
2460	5f 6f 62 72 61 27 29 3b  0d 0a 20 72 65 73 2e 72   _obra');.. res.r
2470	65 6e 64 65 72 28 27 63  6f 6d 75 6e 69 63 61 63   ender('comunicac
2480	61 6f 27 2c 20 7b 20 6d  65 6e 73 61 67 65 6e 73   ao', { mensagens
2490	3a 20 6d 65 6e 73 61 67  65 6e 73 20 7c 7c 20 5b   : mensagens || [
24a0	5d 2c 20 6f 62 72 61 73  3a 20 6f 62 72 61 73 20   ], obras: obras 
24b0	7c 7c 20 5b 5d 20 7d 29  3b 0d 0a 20 7d 20 63 61   || [] });.. } ca
24c0	74 63 68 20 28 65 72 72  29 20 7b 0d 0a 20 63 6f   tch (err) {.. co
24d0	6e 73 6f 6c 65 2e 65 72  72 6f 72 28 27 45 72 72   nsole.error('Err
24e0	6f 20 61 6f 20 63 61 72  72 65 67 61 72 20 63 6f   o ao carregar co
24f0	6d 75 6e 69 63 61 c3 a7  c3 a3 6f 3a 27 2c 20 65   munica....o:', e
2500	72 72 29 3b 0d 0a 20 72  65 73 2e 73 74 61 74 75   rr);.. res.statu
2510	73 28 35 30 30 29 2e 72  65 6e 64 65 72 28 27 65   s(500).render('e
2520	72 72 6f 72 27 2c 20 7b  20 6d 65 73 73 61 67 65   rror', { message
2530	3a 20 27 45 72 72 6f 20  69 6e 74 65 72 6e 6f 20   : 'Erro interno 
2540	64 6f 20 73 65 72 76 69  64 6f 72 27 20 7d 29 3b   do servidor' });
2550	0d 0a 20 7d 0d 0a 7d 3b  0d 0a 0d 0a 65 78 70 6f   .. }..};....expo
2560	72 74 73 2e 63 72 69 61  72 4d 65 6e 73 61 67 65   rts.criarMensage
2570	6d 20 3d 20 61 73 79 6e  63 20 28 72 65 71 2c 20   m = async (req, 
2580	72 65 73 29 20 3d 3e 20  7b 0d 0a 20 74 72 79 20   res) => {.. try 
2590	7b 0d 0a 20 63 6f 6e 73  74 20 7b 20 64 65 2c 20   {.. const { de, 
25a0	70 61 72 61 2c 20 6d 65  6e 73 61 67 65 6d 2c 20   para, mensagem, 
25b0	64 61 74 61 2c 20 6f 62  72 61 5f 69 64 20 7d 20   data, obra_id } 
25c0	3d 20 72 65 71 2e 62 6f  64 79 3b 0d 0a 20 61 77   = req.body;.. aw
25d0	61 69 74 20 64 62 2e 65  78 65 63 75 74 65 28 60   ait db.execute(`
25e0	49 4e 53 45 52 54 20 49  4e 54 4f 20 6d 65 6e 73   INSERT INTO mens
25f0	61 67 65 6e 73 20 28 64  65 2c 20 70 61 72 61 2c   agens (de, para,
2600	20 6d 65 6e 73 61 67 65  6d 2c 20 64 61 74 61 2c    mensagem, data,
2610	20 6f 62 72 61 5f 69 64  29 20 56 41 4c 55 45 53    obra_id) VALUES
2620	20 28 3f 2c 20 3f 2c 20  3f 2c 20 3f 2c 20 3f 29    (?, ?, ?, ?, ?)
2630	60 2c 0d 0a 20 5b 64 65  2c 20 70 61 72 61 2c 20   `,.. [de, para, 
2640	6d 65 6e 73 61 67 65 6d  2c 20 64 61 74 61 2c 20   mensagem, data, 
2650	6f 62 72 61 5f 69 64 5d  29 3b 0d 0a 20 72 65 73   obra_id]);.. res
2660	2e 72 65 64 69 72 65 63  74 28 27 2f 64 61 73 68   .redirect('/dash
2670	62 6f 61 72 64 2f 63 6f  6e 74 72 6f 6c 65 20 67   board/controle g
2680	65 72 61 6c 2f 63 6f 6d  75 6e 69 63 61 63 61 6f   eral/comunicacao
2690	27 29 3b 0d 0a 20 7d 20  63 61 74 63 68 20 28 65   ');.. } catch (e
26a0	72 72 29 20 7b 0d 0a 20  63 6f 6e 73 6f 6c 65 2e   rr) {.. console.
26b0	65 72 72 6f 72 28 27 45  72 72 6f 20 61 6f 20 63   error('Erro ao c
26c0	72 69 61 72 20 6d 65 6e  73 61 67 65 6d 3a 27 2c   riar mensagem:',
26d0	20 65 72 72 29 3b 0d 0a  20 72 65 73 2e 73 74 61    err);.. res.sta
26e0	74 75 73 28 35 30 30 29  2e 6a 73 6f 6e 28 7b 20   tus(500).json({ 
26f0	65 72 72 6f 72 3a 20 27  45 72 72 6f 20 69 6e 74   error: 'Erro int
2700	65 72 6e 6f 20 64 6f 20  73 65 72 76 69 64 6f 72   erno do servidor
2710	27 20 7d 29 3b 0d 0a 20  7d 0d 0a 20 7d 3b 0d 0a   ' });.. }.. };..
2720	0d 0a 2f 2f 20 4d 41 54  45 52 49 41 49 53 20 50   ..// MATERIAIS P
2730	4f 52 20 4f 42 52 41 20  28 4d 79 53 51 4c 29 0d   OR OBRA (MySQL).
2740	0a 65 78 70 6f 72 74 73  2e 6d 61 74 65 72 69 61   .exports.materia
2750	69 73 4f 62 72 61 20 3d  20 61 73 79 6e 63 20 28   isObra = async (
2760	72 65 71 2c 20 72 65 73  29 20 3d 3e 20 7b 0d 0a   req, res) => {..
2770	20 74 72 79 20 7b 0d 0a  20 63 6f 6e 73 74 20 6f    try {.. const o
2780	62 72 61 49 64 20 3d 20  72 65 71 2e 70 61 72 61   braId = req.para
2790	6d 73 2e 6f 62 72 61 5f  69 64 3b 0d 0a 0d 0a 20   ms.obra_id;.... 
27a0	2f 2f 20 56 65 72 69 66  69 63 61 72 20 73 65 20   // Verificar se 
27b0	6f 62 72 61 20 65 78 69  73 74 65 0d 0a 20 63 6f   obra existe.. co
27c0	6e 73 74 20 5b 6f 62 72  61 5d 20 3d 20 61 77 61   nst [obra] = awa
27d0	69 74 20 6d 61 69 6e 44  62 2e 65 78 65 63 75 74   it mainDb.execut
27e0	65 28 27 53 45 4c 45 43  54 20 2a 20 46 52 4f 4d   e('SELECT * FROM
27f0	20 6f 62 72 61 73 20 57  48 45 52 45 20 69 64 20    obras WHERE id 
2800	3d 20 3f 27 2c 20 5b 6f  62 72 61 49 64 5d 29 3b   = ?', [obraId]);
2810	0d 0a 20 69 66 20 28 21  6f 62 72 61 5b 30 5d 29   .. if (!obra[0])
2820	20 7b 0d 0a 20 72 65 74  75 72 6e 20 72 65 73 2e    {.. return res.
2830	73 74 61 74 75 73 28 34  30 34 29 2e 72 65 6e 64   status(404).rend
2840	65 72 28 27 65 72 72 6f  72 27 2c 20 7b 20 6d 65   er('error', { me
2850	73 73 61 67 65 3a 20 27  4f 62 72 61 20 6e c3 a3   ssage: 'Obra n..
2860	6f 20 65 6e 63 6f 6e 74  72 61 64 61 27 20 7d 29   o encontrada' })
2870	3b 0d 0a 20 7d 0d 0a 0d  0a 20 2f 2f 20 42 75 73   ;.. }.... // Bus
2880	63 61 72 20 6d 61 74 65  72 69 61 69 73 20 64 61   car materiais da
2890	20 6f 62 72 61 0d 0a 20  63 6f 6e 73 74 20 5b 6d    obra.. const [m
28a0	61 74 65 72 69 61 69 73  5d 20 3d 20 61 77 61 69   ateriais] = awai
28b0	74 20 6d 61 69 6e 44 62  2e 65 78 65 63 75 74 65   t mainDb.execute
28c0	28 60 0d 0a 20 53 45 4c  45 43 54 0d 0a 20 6d 6f   (`.. SELECT.. mo
28d0	2e 2a 2c 0d 0a 20 6d 2e  6e 6f 6d 65 20 61 73 20   .*,.. m.nome as 
28e0	6d 61 74 65 72 69 61 6c  5f 6e 6f 6d 65 2c 0d 0a   material_nome,..
28f0	20 6d 2e 64 65 73 63 72  69 63 61 6f 2c 0d 0a 20    m.descricao,.. 
2900	6d 2e 75 6e 69 64 61 64  65 2c 0d 0a 20 6d 2e 70   m.unidade,.. m.p
2910	72 65 63 6f 5f 75 6e 69  74 61 72 69 6f 0d 0a 20   reco_unitario.. 
2920	46 52 4f 4d 20 6d 61 74  65 72 69 61 69 73 5f 6f   FROM materiais_o
2930	62 72 61 20 6d 6f 0d 0a  20 4a 4f 49 4e 20 6d 61   bra mo.. JOIN ma
2940	74 65 72 69 61 69 73 20  6d 20 4f 4e 20 6d 6f 2e   teriais m ON mo.
2950	6d 61 74 65 72 69 61 6c  5f 69 64 20 3d 20 6d 2e   material_id = m.
2960	69 64 0d 0a 20 57 48 45  52 45 20 6d 6f 2e 6f 62   id.. WHERE mo.ob
2970	72 61 5f 69 64 20 3d 20  3f 20 41 4e 44 20 6d 6f   ra_id = ? AND mo
2980	2e 61 74 69 76 6f 20 3d  20 54 52 55 45 0d 0a 20   .ativo = TRUE.. 
2990	4f 52 44 45 52 20 42 59  20 6d 6f 2e 66 61 73 65   ORDER BY mo.fase
29a0	5f 6f 62 72 61 20 41 53  43 2c 20 6d 2e 6e 6f 6d   _obra ASC, m.nom
29b0	65 20 41 53 43 0d 0a 20  60 2c 20 5b 6f 62 72 61   e ASC.. `, [obra
29c0	49 64 5d 29 3b 0d 0a 0d  0a 20 2f 2f 20 42 75 73   Id]);.... // Bus
29d0	63 61 72 20 66 61 73 65  73 2f 65 74 61 70 61 73   car fases/etapas
29e0	20 64 61 20 6f 62 72 61  0d 0a 20 63 6f 6e 73 74    da obra.. const
29f0	20 5b 65 74 61 70 61 73  5d 20 3d 20 61 77 61 69    [etapas] = awai
2a00	74 20 6d 61 69 6e 44 62  2e 65 78 65 63 75 74 65   t mainDb.execute
2a10	28 60 0d 0a 20 53 45 4c  45 43 54 20 44 49 53 54   (`.. SELECT DIST
2a20	49 4e 43 54 20 66 61 73  65 5f 6f 62 72 61 0d 0a   INCT fase_obra..
2a30	20 46 52 4f 4d 20 6d 61  74 65 72 69 61 69 73 5f    FROM materiais_
2a40	6f 62 72 61 0d 0a 20 57  48 45 52 45 20 6f 62 72   obra.. WHERE obr
2a50	61 5f 69 64 20 3d 20 3f  20 41 4e 44 20 61 74 69   a_id = ? AND ati
2a60	76 6f 20 3d 20 54 52 55  45 20 41 4e 44 20 66 61   vo = TRUE AND fa
2a70	73 65 5f 6f 62 72 61 20  49 53 20 4e 4f 54 20 4e   se_obra IS NOT N
2a80	55 4c 4c 0d 0a 20 4f 52  44 45 52 20 42 59 20 66   ULL.. ORDER BY f
2a90	61 73 65 5f 6f 62 72 61  0d 0a 20 60 2c 20 5b 6f   ase_obra.. `, [o
2aa0	62 72 61 49 64 5d 29 3b  0d 0a 0d 0a 20 2f 2f 20   braId]);.... // 
2ab0	42 75 73 63 61 72 20 6d  61 74 65 72 69 61 69 73   Buscar materiais
2ac0	20 64 69 73 70 6f 6e c3  ad 76 65 69 73 20 70 61    dispon..veis pa
2ad0	72 61 20 61 64 69 63 69  6f 6e 61 72 0d 0a 20 63   ra adicionar.. c
2ae0	6f 6e 73 74 20 5b 6d 61  74 65 72 69 61 69 73 44   onst [materiaisD
2af0	69 73 70 6f 6e 69 76 65  69 73 5d 20 3d 20 61 77   isponiveis] = aw
2b00	61 69 74 20 6d 61 69 6e  44 62 2e 65 78 65 63 75   ait mainDb.execu
2b10	74 65 28 60 0d 0a 20 53  45 4c 45 43 54 20 69 64   te(`.. SELECT id
2b20	2c 20 6e 6f 6d 65 2c 20  75 6e 69 64 61 64 65 2c   , nome, unidade,
2b30	20 63 61 74 65 67 6f 72  69 61 0d 0a 20 46 52 4f    categoria.. FRO
2b40	4d 20 6d 61 74 65 72 69  61 69 73 0d 0a 20 4f 52   M materiais.. OR
2b50	44 45 52 20 42 59 20 6e  6f 6d 65 20 41 53 43 0d   DER BY nome ASC.
2b60	0a 20 60 29 3b 0d 0a 0d  0a 20 72 65 73 2e 72 65   . `);.... res.re
2b70	6e 64 65 72 28 27 6d 61  74 65 72 69 61 69 73 4f   nder('materiaisO
2b80	62 72 61 27 2c 20 7b 0d  0a 20 6f 62 72 61 3a 20   bra', {.. obra: 
2b90	6f 62 72 61 5b 30 5d 2c  0d 0a 20 6d 61 74 65 72   obra[0],.. mater
2ba0	69 61 69 73 3a 20 6d 61  74 65 72 69 61 69 73 20   iais: materiais 
2bb0	7c 7c 20 5b 5d 2c 0d 0a  20 65 74 61 70 61 73 3a   || [],.. etapas:
2bc0	20 65 74 61 70 61 73 2e  6d 61 70 28 65 20 3d 3e    etapas.map(e =>
2bd0	20 65 2e 66 61 73 65 5f  6f 62 72 61 29 20 7c 7c    e.fase_obra) ||
2be0	20 5b 5d 2c 0d 0a 20 6d  61 74 65 72 69 61 69 73    [],.. materiais
2bf0	44 69 73 70 6f 6e 69 76  65 69 73 3a 20 6d 61 74   Disponiveis: mat
2c00	65 72 69 61 69 73 44 69  73 70 6f 6e 69 76 65 69   eriaisDisponivei
2c10	73 20 7c 7c 20 5b 5d 0d  0a 20 7d 29 3b 0d 0a 20   s || [].. });.. 
2c20	7d 20 63 61 74 63 68 20  28 65 72 72 29 20 7b 0d   } catch (err) {.
2c30	0a 20 63 6f 6e 73 6f 6c  65 2e 65 72 72 6f 72 28   . console.error(
2c40	27 45 72 72 6f 20 61 6f  20 63 61 72 72 65 67 61   'Erro ao carrega
2c50	72 20 6d 61 74 65 72 69  61 69 73 20 64 61 20 6f   r materiais da o
2c60	62 72 61 3a 27 2c 20 65  72 72 29 3b 0d 0a 20 72   bra:', err);.. r
2c70	65 73 2e 73 74 61 74 75  73 28 35 30 30 29 2e 72   es.status(500).r
2c80	65 6e 64 65 72 28 27 65  72 72 6f 72 27 2c 20 7b   ender('error', {
2c90	20 6d 65 73 73 61 67 65  3a 20 27 45 72 72 6f 20    message: 'Erro 
2ca0	69 6e 74 65 72 6e 6f 20  64 6f 20 73 65 72 76 69   interno do servi
2cb0	64 6f 72 27 20 7d 29 3b  0d 0a 20 7d 0d 0a 7d 3b   dor' });.. }..};
2cc0	0d 0a 0d 0a 65 78 70 6f  72 74 73 2e 61 64 69 63   ....exports.adic
2cd0	69 6f 6e 61 72 4d 61 74  65 72 69 61 6c 4f 62 72   ionarMaterialObr
2ce0	61 20 3d 20 61 73 79 6e  63 20 28 72 65 71 2c 20   a = async (req, 
2cf0	72 65 73 29 20 3d 3e 20  7b 0d 0a 20 74 72 79 20   res) => {.. try 
2d00	7b 0d 0a 20 63 6f 6e 73  74 20 6f 62 72 61 49 64   {.. const obraId
2d10	20 3d 20 72 65 71 2e 70  61 72 61 6d 73 2e 6f 62    = req.params.ob
2d20	72 61 5f 69 64 3b 0d 0a  20 63 6f 6e 73 74 20 7b   ra_id;.. const {
2d30	20 6d 61 74 65 72 69 61  6c 5f 69 64 2c 20 71 75    material_id, qu
2d40	61 6e 74 69 64 61 64 65  5f 65 73 74 69 6d 61 64   antidade_estimad
2d50	61 2c 20 71 75 61 6e 74  69 64 61 64 65 5f 69 6e   a, quantidade_in
2d60	69 63 69 61 6c 2c 20 66  61 73 65 5f 6f 62 72 61   icial, fase_obra
2d70	2c 20 63 61 74 65 67 6f  72 69 61 2c 20 73 75 62   , categoria, sub
2d80	63 61 74 65 67 6f 72 69  61 20 7d 20 3d 20 72 65   categoria } = re
2d90	71 2e 62 6f 64 79 3b 0d  0a 0d 0a 20 2f 2f 20 56   q.body;.... // V
2da0	65 72 69 66 69 63 61 72  20 73 65 20 6a c3 a1 20   erificar se j.. 
2db0	65 78 69 73 74 65 0d 0a  20 63 6f 6e 73 74 20 5b   existe.. const [
2dc0	65 78 69 73 74 65 5d 20  3d 20 61 77 61 69 74 20   existe] = await 
2dd0	6d 61 69 6e 44 62 2e 65  78 65 63 75 74 65 28 0d   mainDb.execute(.
2de0	0a 20 27 53 45 4c 45 43  54 20 69 64 20 46 52 4f   . 'SELECT id FRO
2df0	4d 20 6d 61 74 65 72 69  61 69 73 5f 6f 62 72 61   M materiais_obra
2e00	20 57 48 45 52 45 20 6f  62 72 61 5f 69 64 20 3d    WHERE obra_id =
2e10	20 3f 20 41 4e 44 20 6d  61 74 65 72 69 61 6c 5f    ? AND material_
2e20	69 64 20 3d 20 3f 20 41  4e 44 20 61 74 69 76 6f   id = ? AND ativo
2e30	20 3d 20 54 52 55 45 27  2c 0d 0a 20 5b 6f 62 72    = TRUE',.. [obr
2e40	61 49 64 2c 20 6d 61 74  65 72 69 61 6c 5f 69 64   aId, material_id
2e50	5d 0d 0a 20 29 3b 0d 0a  0d 0a 20 69 66 20 28 65   ].. );.... if (e
2e60	78 69 73 74 65 5b 30 5d  29 20 7b 0d 0a 20 72 65   xiste[0]) {.. re
2e70	74 75 72 6e 20 72 65 73  2e 73 74 61 74 75 73 28   turn res.status(
2e80	34 30 30 29 2e 73 65 6e  64 28 27 4d 61 74 65 72   400).send('Mater
2e90	69 61 6c 20 6a c3 a1 20  61 64 69 63 69 6f 6e 61   ial j.. adiciona
2ea0	64 6f 20 c3 a0 20 6f 62  72 61 27 29 3b 0d 0a 20   do .. obra');.. 
2eb0	7d 0d 0a 0d 0a 20 61 77  61 69 74 20 6d 61 69 6e   }.... await main
2ec0	44 62 2e 65 78 65 63 75  74 65 28 60 0d 0a 20 49   Db.execute(`.. I
2ed0	4e 53 45 52 54 20 49 4e  54 4f 20 6d 61 74 65 72   NSERT INTO mater
2ee0	69 61 69 73 5f 6f 62 72  61 0d 0a 20 28 6f 62 72   iais_obra.. (obr
2ef0	61 5f 69 64 2c 20 6d 61  74 65 72 69 61 6c 5f 69   a_id, material_i
2f00	64 2c 20 71 75 61 6e 74  69 64 61 64 65 5f 65 73   d, quantidade_es
2f10	74 69 6d 61 64 61 2c 20  71 75 61 6e 74 69 64 61   timada, quantida
2f20	64 65 5f 69 6e 69 63 69  61 6c 2c 20 73 61 6c 64   de_inicial, sald
2f30	6f 5f 61 74 75 61 6c 2c  20 66 61 73 65 5f 6f 62   o_atual, fase_ob
2f40	72 61 2c 20 63 61 74 65  67 6f 72 69 61 2c 20 73   ra, categoria, s
2f50	75 62 63 61 74 65 67 6f  72 69 61 29 0d 0a 20 56   ubcategoria).. V
2f60	41 4c 55 45 53 20 28 3f  2c 20 3f 2c 20 3f 2c 20   ALUES (?, ?, ?, 
2f70	3f 2c 20 3f 2c 20 3f 2c  20 3f 2c 20 3f 29 0d 0a   ?, ?, ?, ?, ?)..
2f80	20 60 2c 20 5b 0d 0a 20  6f 62 72 61 49 64 2c 0d    `, [.. obraId,.
2f90	0a 20 6d 61 74 65 72 69  61 6c 5f 69 64 2c 0d 0a   . material_id,..
2fa0	20 71 75 61 6e 74 69 64  61 64 65 5f 65 73 74 69    quantidade_esti
2fb0	6d 61 64 61 20 7c 7c 20  30 2c 0d 0a 20 71 75 61   mada || 0,.. qua
2fc0	6e 74 69 64 61 64 65 5f  69 6e 69 63 69 61 6c 20   ntidade_inicial 
2fd0	7c 7c 20 30 2c 0d 0a 20  71 75 61 6e 74 69 64 61   || 0,.. quantida
2fe0	64 65 5f 69 6e 69 63 69  61 6c 20 7c 7c 20 30 2c   de_inicial || 0,
2ff0	0d 0a 20 66 61 73 65 5f  6f 62 72 61 2c 0d 0a 20   .. fase_obra,.. 
3000	63 61 74 65 67 6f 72 69  61 20 7c 7c 20 6e 75 6c   categoria || nul
3010	6c 2c 0d 0a 20 73 75 62  63 61 74 65 67 6f 72 69   l,.. subcategori
3020	61 20 7c 7c 20 6e 75 6c  6c 0d 0a 20 5d 29 3b 0d   a || null.. ]);.
3030	0a 0d 0a 20 72 65 73 2e  72 65 64 69 72 65 63 74   ... res.redirect
3040	28 60 2f 64 61 73 68 62  6f 61 72 64 2f 63 6f 6e   (`/dashboard/con
3050	74 72 6f 6c 65 20 67 65  72 61 6c 2f 65 73 74 6f   trole geral/esto
3060	71 75 65 2f 6f 62 72 61  2f 24 7b 6f 62 72 61 49   que/obra/${obraI
3070	64 7d 60 29 3b 0d 0a 20  7d 20 63 61 74 63 68 20   d}`);.. } catch 
3080	28 65 72 72 29 20 7b 0d  0a 20 63 6f 6e 73 6f 6c   (err) {.. consol
3090	65 2e 65 72 72 6f 72 28  27 45 72 72 6f 20 61 6f   e.error('Erro ao
30a0	20 61 64 69 63 69 6f 6e  61 72 20 6d 61 74 65 72    adicionar mater
30b0	69 61 6c 20 c3 a0 20 6f  62 72 61 3a 27 2c 20 65   ial .. obra:', e
30c0	72 72 29 3b 0d 0a 20 72  65 73 2e 73 74 61 74 75   rr);.. res.statu
30d0	73 28 35 30 30 29 2e 73  65 6e 64 28 27 45 72 72   s(500).send('Err
30e0	6f 20 69 6e 74 65 72 6e  6f 20 64 6f 20 73 65 72   o interno do ser
30f0	76 69 64 6f 72 27 29 3b  0d 0a 20 7d 0d 0a 7d 3b   vidor');.. }..};
3100	0d 0a 0d 0a 65 78 70 6f  72 74 73 2e 65 64 69 74   ....exports.edit
3110	61 72 4d 61 74 65 72 69  61 6c 4f 62 72 61 20 3d   arMaterialObra =
3120	20 61 73 79 6e 63 20 28  72 65 71 2c 20 72 65 73    async (req, res
3130	29 20 3d 3e 20 7b 0d 0a  20 74 72 79 20 7b 0d 0a   ) => {.. try {..
3140	20 63 6f 6e 73 74 20 7b  20 6f 62 72 61 5f 69 64    const { obra_id
3150	2c 20 6d 61 74 65 72 69  61 6c 5f 6f 62 72 61 5f   , material_obra_
3160	69 64 20 7d 20 3d 20 72  65 71 2e 70 61 72 61 6d   id } = req.param
3170	73 3b 0d 0a 20 63 6f 6e  73 74 20 7b 20 71 75 61   s;.. const { qua
3180	6e 74 69 64 61 64 65 5f  65 73 74 69 6d 61 64 61   ntidade_estimada
3190	2c 20 71 75 61 6e 74 69  64 61 64 65 5f 69 6e 69   , quantidade_ini
31a0	63 69 61 6c 2c 20 66 61  73 65 5f 6f 62 72 61 2c   cial, fase_obra,
31b0	20 63 61 74 65 67 6f 72  69 61 2c 20 73 75 62 63    categoria, subc
31c0	61 74 65 67 6f 72 69 61  20 7d 20 3d 20 72 65 71   ategoria } = req
31d0	2e 62 6f 64 79 3b 0d 0a  0d 0a 20 61 77 61 69 74   .body;.... await
31e0	20 6d 61 69 6e 44 62 2e  65 78 65 63 75 74 65 28    mainDb.execute(
31f0	60 0d 0a 20 55 50 44 41  54 45 20 6d 61 74 65 72   `.. UPDATE mater
3200	69 61 69 73 5f 6f 62 72  61 0d 0a 20 53 45 54 20   iais_obra.. SET 
3210	71 75 61 6e 74 69 64 61  64 65 5f 65 73 74 69 6d   quantidade_estim
3220	61 64 61 20 3d 20 3f 2c  20 71 75 61 6e 74 69 64   ada = ?, quantid
3230	61 64 65 5f 69 6e 69 63  69 61 6c 20 3d 20 3f 2c   ade_inicial = ?,
3240	20 66 61 73 65 5f 6f 62  72 61 20 3d 20 3f 2c 20    fase_obra = ?, 
3250	63 61 74 65 67 6f 72 69  61 20 3d 20 3f 2c 20 73   categoria = ?, s
3260	75 62 63 61 74 65 67 6f  72 69 61 20 3d 20 3f 2c   ubcategoria = ?,
3270	20 75 70 64 61 74 65 64  5f 61 74 20 3d 20 4e 4f    updated_at = NO
3280	57 28 29 0d 0a 20 57 48  45 52 45 20 69 64 20 3d   W().. WHERE id =
3290	20 3f 20 41 4e 44 20 6f  62 72 61 5f 69 64 20 3d    ? AND obra_id =
32a0	20 3f 0d 0a 20 60 2c 20  5b 0d 0a 20 71 75 61 6e    ?.. `, [.. quan
32b0	74 69 64 61 64 65 5f 65  73 74 69 6d 61 64 61 2c   tidade_estimada,
32c0	0d 0a 20 66 61 73 65 5f  6f 62 72 61 2c 0d 0a 20   .. fase_obra,.. 
32d0	63 61 74 65 67 6f 72 69  61 20 7c 7c 20 6e 75 6c   categoria || nul
32e0	6c 2c 0d 0a 20 73 75 62  63 61 74 65 67 6f 72 69   l,.. subcategori
32f0	61 20 7c 7c 20 6e 75 6c  6c 2c 0d 0a 20 6d 61 74   a || null,.. mat
3300	65 72 69 61 6c 5f 6f 62  72 61 5f 69 64 2c 0d 0a   erial_obra_id,..
3310	20 6f 62 72 61 5f 69 64  0d 0a 20 5d 29 3b 0d 0a    obra_id.. ]);..
3320	0d 0a 20 72 65 73 2e 72  65 64 69 72 65 63 74 28   .. res.redirect(
3330	60 2f 64 61 73 68 62 6f  61 72 64 2f 63 6f 6e 74   `/dashboard/cont
3340	72 6f 6c 65 20 67 65 72  61 6c 2f 65 73 74 6f 71   role geral/estoq
3350	75 65 2f 6f 62 72 61 2f  24 7b 6f 62 72 61 5f 69   ue/obra/${obra_i
3360	64 7d 60 29 3b 0d 0a 20  7d 20 63 61 74 63 68 20   d}`);.. } catch 
3370	28 65 72 72 29 20 7b 0d  0a 20 63 6f 6e 73 6f 6c   (err) {.. consol
3380	65 2e 65 72 72 6f 72 28  27 45 72 72 6f 20 61 6f   e.error('Erro ao
3390	20 65 64 69 74 61 72 20  6d 61 74 65 72 69 61 6c    editar material
33a0	20 64 61 20 6f 62 72 61  3a 27 2c 20 65 72 72 29    da obra:', err)
33b0	3b 0d 0a 20 72 65 73 2e  73 74 61 74 75 73 28 35   ;.. res.status(5
33c0	30 30 29 2e 73 65 6e 64  28 27 45 72 72 6f 20 69   00).send('Erro i
33d0	6e 74 65 72 6e 6f 20 64  6f 20 73 65 72 76 69 64   nterno do servid
33e0	6f 72 27 29 3b 0d 0a 20  7d 0d 0a 7d 3b 0d 0a 0d   or');.. }..};...
33f0	0a 65 78 70 6f 72 74 73  2e 72 65 6d 6f 76 65 72   .exports.remover
3400	4d 61 74 65 72 69 61 6c  4f 62 72 61 20 3d 20 61   MaterialObra = a
3410	73 79 6e 63 20 28 72 65  71 2c 20 72 65 73 29 20   sync (req, res) 
3420	3d 3e 20 7b 0d 0a 20 74  72 79 20 7b 0d 0a 20 63   => {.. try {.. c
3430	6f 6e 73 74 20 7b 20 6f  62 72 61 5f 69 64 2c 20   onst { obra_id, 
3440	6d 61 74 65 72 69 61 6c  5f 6f 62 72 61 5f 69 64   material_obra_id
3450	20 7d 20 3d 20 72 65 71  2e 70 61 72 61 6d 73 3b    } = req.params;
3460	0d 0a 0d 0a 20 61 77 61  69 74 20 6d 61 69 6e 44   .... await mainD
3470	62 2e 65 78 65 63 75 74  65 28 0d 0a 20 27 55 50   b.execute(.. 'UP
3480	44 41 54 45 20 6d 61 74  65 72 69 61 69 73 5f 6f   DATE materiais_o
3490	62 72 61 20 53 45 54 20  61 74 69 76 6f 20 3d 20   bra SET ativo = 
34a0	46 41 4c 53 45 20 57 48  45 52 45 20 69 64 20 3d   FALSE WHERE id =
34b0	20 3f 20 41 4e 44 20 6f  62 72 61 5f 69 64 20 3d    ? AND obra_id =
34c0	20 3f 27 2c 0d 0a 20 5b  6d 61 74 65 72 69 61 6c    ?',.. [material
34d0	5f 6f 62 72 61 5f 69 64  2c 20 6f 62 72 61 5f 69   _obra_id, obra_i
34e0	64 5d 0d 0a 20 29 3b 0d  0a 0d 0a 20 72 65 73 2e   d].. );.... res.
34f0	72 65 64 69 72 65 63 74  28 60 2f 64 61 73 68 62   redirect(`/dashb
3500	6f 61 72 64 2f 63 6f 6e  74 72 6f 6c 65 20 67 65   oard/controle ge
3510	72 61 6c 2f 65 73 74 6f  71 75 65 2f 6f 62 72 61   ral/estoque/obra
3520	2f 24 7b 6f 62 72 61 5f  69 64 7d 60 29 3b 0d 0a   /${obra_id}`);..
3530	20 7d 20 63 61 74 63 68  20 28 65 72 72 29 20 7b    } catch (err) {
3540	0d 0a 20 63 6f 6e 73 6f  6c 65 2e 65 72 72 6f 72   .. console.error
3550	28 27 45 72 72 6f 20 61  6f 20 72 65 6d 6f 76 65   ('Erro ao remove
3560	72 20 6d 61 74 65 72 69  61 6c 20 64 61 20 6f 62   r material da ob
3570	72 61 3a 27 2c 20 65 72  72 29 3b 0d 0a 20 72 65   ra:', err);.. re
3580	73 2e 73 74 61 74 75 73  28 35 30 30 29 2e 73 65   s.status(500).se
3590	6e 64 28 27 45 72 72 6f  20 69 6e 74 65 72 6e 6f   nd('Erro interno
35a0	20 64 6f 20 73 65 72 76  69 64 6f 72 27 29 3b 0d    do servidor');.
35b0	0a 20 7d 0d 0a 7d 3b 0d  0a 0d 0a 2f 2f 20 4d 4f   . }..};....// MO
35c0	56 49 4d 45 4e 54 41 c3  87 c3 95 45 53 20 44 45   VIMENTA....ES DE
35d0	20 4d 41 54 45 52 49 41  49 53 20 4e 41 20 4f 42    MATERIAIS NA OB
35e0	52 41 0d 0a 65 78 70 6f  72 74 73 2e 6d 6f 76 69   RA..exports.movi
35f0	6d 65 6e 74 61 63 6f 65  73 4f 62 72 61 20 3d 20   mentacoesObra = 
3600	61 73 79 6e 63 20 28 72  65 71 2c 20 72 65 73 29   async (req, res)
3610	20 3d 3e 20 7b 0d 0a 20  74 72 79 20 7b 0d 0a 20    => {.. try {.. 
3620	63 6f 6e 73 74 20 6f 62  72 61 49 64 20 3d 20 72   const obraId = r
3630	65 71 2e 70 61 72 61 6d  73 2e 6f 62 72 61 5f 69   eq.params.obra_i
3640	64 3b 0d 0a 0d 0a 20 2f  2f 20 56 65 72 69 66 69   d;.... // Verifi
3650	63 61 72 20 6f 62 72 61  0d 0a 20 63 6f 6e 73 74   car obra.. const
3660	20 5b 6f 62 72 61 5d 20  3d 20 61 77 61 69 74 20    [obra] = await 
3670	6d 61 69 6e 44 62 2e 65  78 65 63 75 74 65 28 27   mainDb.execute('
3680	53 45 4c 45 43 54 20 2a  20 46 52 4f 4d 20 6f 62   SELECT * FROM ob
3690	72 61 73 20 57 48 45 52  45 20 69 64 20 3d 20 3f   ras WHERE id = ?
36a0	27 2c 20 5b 6f 62 72 61  49 64 5d 29 3b 0d 0a 20   ', [obraId]);.. 
36b0	69 66 20 28 21 6f 62 72  61 5b 30 5d 29 20 7b 0d   if (!obra[0]) {.
36c0	0a 20 72 65 74 75 72 6e  20 72 65 73 2e 73 74 61   . return res.sta
36d0	74 75 73 28 34 30 34 29  2e 72 65 6e 64 65 72 28   tus(404).render(
36e0	27 65 72 72 6f 72 27 2c  20 7b 20 6d 65 73 73 61   'error', { messa
36f0	67 65 3a 20 27 4f 62 72  61 20 6e c3 a3 6f 20 65   ge: 'Obra n..o e
3700	6e 63 6f 6e 74 72 61 64  61 27 20 7d 29 3b 0d 0a   ncontrada' });..
3710	20 7d 0d 0a 0d 0a 20 2f  2f 20 42 75 73 63 61 72    }.... // Buscar
3720	20 6d 6f 76 69 6d 65 6e  74 61 c3 a7 c3 b5 65 73    movimenta....es
3730	0d 0a 20 63 6f 6e 73 74  20 5b 6d 6f 76 69 6d 65   .. const [movime
3740	6e 74 61 63 6f 65 73 5d  20 3d 20 61 77 61 69 74   ntacoes] = await
3750	20 6d 61 69 6e 44 62 2e  65 78 65 63 75 74 65 28    mainDb.execute(
3760	60 0d 0a 20 53 45 4c 45  43 54 0d 0a 20 6d 6f 2e   `.. SELECT.. mo.
3770	2a 2c 0d 0a 20 6d 6f 62  2e 66 61 73 65 5f 6f 62   *,.. mob.fase_ob
3780	72 61 2c 0d 0a 20 6d 2e  6e 6f 6d 65 20 61 73 20   ra,.. m.nome as 
3790	6d 61 74 65 72 69 61 6c  5f 6e 6f 6d 65 2c 0d 0a   material_nome,..
37a0	20 6d 2e 75 6e 69 64 61  64 65 2c 0d 0a 20 61 2e    m.unidade,.. a.
37b0	6e 6f 6d 65 20 61 73 20  72 65 73 70 6f 6e 73 61   nome as responsa
37c0	76 65 6c 5f 6e 6f 6d 65  0d 0a 20 46 52 4f 4d 20   vel_nome.. FROM 
37d0	6d 6f 76 69 6d 65 6e 74  61 63 6f 65 73 5f 6f 62   movimentacoes_ob
37e0	72 61 20 6d 6f 0d 0a 20  4a 4f 49 4e 20 6d 61 74   ra mo.. JOIN mat
37f0	65 72 69 61 69 73 5f 6f  62 72 61 20 6d 6f 62 20   eriais_obra mob 
3800	4f 4e 20 6d 6f 2e 6d 61  74 65 72 69 61 6c 5f 6f   ON mo.material_o
3810	62 72 61 5f 69 64 20 3d  20 6d 6f 62 2e 69 64 0d   bra_id = mob.id.
3820	0a 20 4a 4f 49 4e 20 6d  61 74 65 72 69 61 69 73   . JOIN materiais
3830	20 6d 20 4f 4e 20 6d 6f  62 2e 6d 61 74 65 72 69    m ON mob.materi
3840	61 6c 5f 69 64 20 3d 20  6d 2e 69 64 0d 0a 20 4a   al_id = m.id.. J
3850	4f 49 4e 20 61 64 6d 69  6e 73 20 61 20 4f 4e 20   OIN admins a ON 
3860	6d 6f 2e 72 65 73 70 6f  6e 73 61 76 65 6c 5f 69   mo.responsavel_i
3870	64 20 3d 20 61 2e 69 64  0d 0a 20 57 48 45 52 45   d = a.id.. WHERE
3880	20 6d 6f 2e 6f 62 72 61  5f 69 64 20 3d 20 3f 0d    mo.obra_id = ?.
3890	0a 20 4f 52 44 45 52 20  42 59 20 6d 6f 2e 64 61   . ORDER BY mo.da
38a0	74 61 5f 6d 6f 76 69 6d  65 6e 74 61 63 61 6f 20   ta_movimentacao 
38b0	44 45 53 43 2c 20 6d 6f  2e 63 72 65 61 74 65 64   DESC, mo.created
38c0	5f 61 74 20 44 45 53 43  0d 0a 20 60 2c 20 5b 6f   _at DESC.. `, [o
38d0	62 72 61 49 64 5d 29 3b  0d 0a 0d 0a 20 2f 2f 20   braId]);.... // 
38e0	42 75 73 63 61 72 20 6d  61 74 65 72 69 61 69 73   Buscar materiais
38f0	20 64 61 20 6f 62 72 61  20 70 61 72 61 20 6f 20    da obra para o 
3900	64 72 6f 70 64 6f 77 6e  0d 0a 20 63 6f 6e 73 74   dropdown.. const
3910	20 5b 6d 61 74 65 72 69  61 69 73 4f 62 72 61 5d    [materiaisObra]
3920	20 3d 20 61 77 61 69 74  20 6d 61 69 6e 44 62 2e    = await mainDb.
3930	65 78 65 63 75 74 65 28  60 0d 0a 20 53 45 4c 45   execute(`.. SELE
3940	43 54 0d 0a 20 6d 6f 2e  69 64 2c 0d 0a 20 6d 2e   CT.. mo.id,.. m.
3950	6e 6f 6d 65 20 61 73 20  6d 61 74 65 72 69 61 6c   nome as material
3960	5f 6e 6f 6d 65 2c 0d 0a  20 6d 6f 2e 66 61 73 65   _nome,.. mo.fase
3970	5f 6f 62 72 61 0d 0a 20  46 52 4f 4d 20 6d 61 74   _obra.. FROM mat
3980	65 72 69 61 69 73 5f 6f  62 72 61 20 6d 6f 0d 0a   eriais_obra mo..
3990	20 4a 4f 49 4e 20 6d 61  74 65 72 69 61 69 73 20    JOIN materiais 
39a0	6d 20 4f 4e 20 6d 6f 2e  6d 61 74 65 72 69 61 6c   m ON mo.material
39b0	5f 69 64 20 3d 20 6d 2e  69 64 0d 0a 20 57 48 45   _id = m.id.. WHE
39c0	52 45 20 6d 6f 2e 6f 62  72 61 5f 69 64 20 3d 20   RE mo.obra_id = 
39d0	3f 20 41 4e 44 20 6d 6f  2e 61 74 69 76 6f 20 3d   ? AND mo.ativo =
39e0	20 54 52 55 45 0d 0a 20  4f 52 44 45 52 20 42 59    TRUE.. ORDER BY
39f0	20 6d 2e 6e 6f 6d 65 20  41 53 43 0d 0a 20 60 2c    m.nome ASC.. `,
3a00	20 5b 6f 62 72 61 49 64  5d 29 3b 0d 0a 0d 0a 20    [obraId]);.... 
3a10	72 65 73 2e 72 65 6e 64  65 72 28 27 6d 6f 76 69   res.render('movi
3a20	6d 65 6e 74 61 63 6f 65  73 4f 62 72 61 27 2c 20   mentacoesObra', 
3a30	7b 0d 0a 20 6f 62 72 61  3a 20 6f 62 72 61 5b 30   {.. obra: obra[0
3a40	5d 2c 0d 0a 20 6d 6f 76  69 6d 65 6e 74 61 63 6f   ],.. movimentaco
3a50	65 73 3a 20 6d 6f 76 69  6d 65 6e 74 61 63 6f 65   es: movimentacoe
3a60	73 20 7c 7c 20 5b 5d 2c  0d 0a 20 6d 61 74 65 72   s || [],.. mater
3a70	69 61 69 73 4f 62 72 61  3a 20 6d 61 74 65 72 69   iaisObra: materi
3a80	61 69 73 4f 62 72 61 20  7c 7c 20 5b 5d 0d 0a 20   aisObra || [].. 
3a90	7d 29 3b 0d 0a 20 7d 20  63 61 74 63 68 20 28 65   });.. } catch (e
3aa0	72 72 29 20 7b 0d 0a 20  63 6f 6e 73 6f 6c 65 2e   rr) {.. console.
3ab0	65 72 72 6f 72 28 27 45  72 72 6f 20 61 6f 20 63   error('Erro ao c
3ac0	61 72 72 65 67 61 72 20  6d 6f 76 69 6d 65 6e 74   arregar moviment
3ad0	61 c3 a7 c3 b5 65 73 20  64 61 20 6f 62 72 61 3a   a....es da obra:
3ae0	27 2c 20 65 72 72 29 3b  0d 0a 20 72 65 73 2e 73   ', err);.. res.s
3af0	74 61 74 75 73 28 35 30  30 29 2e 72 65 6e 64 65   tatus(500).rende
3b00	72 28 27 65 72 72 6f 72  27 2c 20 7b 20 6d 65 73   r('error', { mes
3b10	73 61 67 65 3a 20 27 45  72 72 6f 20 69 6e 74 65   sage: 'Erro inte
3b20	72 6e 6f 20 64 6f 20 73  65 72 76 69 64 6f 72 27   rno do servidor'
3b30	20 7d 29 3b 0d 0a 20 7d  0d 0a 7d 3b 0d 0a 0d 0a    });.. }..};....
3b40	65 78 70 6f 72 74 73 2e  72 65 67 69 73 74 72 61   exports.registra
3b50	72 45 6e 74 72 61 64 61  4f 62 72 61 20 3d 20 61   rEntradaObra = a
3b60	73 79 6e 63 20 28 72 65  71 2c 20 72 65 73 29 20   sync (req, res) 
3b70	3d 3e 20 7b 0d 0a 20 74  72 79 20 7b 0d 0a 20 63   => {.. try {.. c
3b80	6f 6e 73 74 20 6f 62 72  61 49 64 20 3d 20 72 65   onst obraId = re
3b90	71 2e 70 61 72 61 6d 73  2e 6f 62 72 61 5f 69 64   q.params.obra_id
3ba0	3b 0d 0a 20 63 6f 6e 73  74 20 7b 20 6d 61 74 65   ;.. const { mate
3bb0	72 69 61 6c 5f 6f 62 72  61 5f 69 64 2c 20 71 75   rial_obra_id, qu
3bc0	61 6e 74 69 64 61 64 65  2c 20 65 74 61 70 61 5f   antidade, etapa_
3bd0	6f 62 72 61 2c 20 6d 6f  74 69 76 6f 2c 20 64 6f   obra, motivo, do
3be0	63 75 6d 65 6e 74 6f 2c  20 64 61 74 61 5f 6d 6f   cumento, data_mo
3bf0	76 69 6d 65 6e 74 61 63  61 6f 2c 20 6f 62 73 65   vimentacao, obse
3c00	72 76 61 63 6f 65 73 20  7d 20 3d 20 72 65 71 2e   rvacoes } = req.
3c10	62 6f 64 79 3b 0d 0a 0d  0a 20 61 77 61 69 74 20   body;.... await 
3c20	6d 61 69 6e 44 62 2e 65  78 65 63 75 74 65 28 60   mainDb.execute(`
3c30	0d 0a 20 49 4e 53 45 52  54 20 49 4e 54 4f 20 6d   .. INSERT INTO m
3c40	6f 76 69 6d 65 6e 74 61  63 6f 65 73 5f 6f 62 72   ovimentacoes_obr
3c50	61 0d 0a 20 28 6f 62 72  61 5f 69 64 2c 20 6d 61   a.. (obra_id, ma
3c60	74 65 72 69 61 6c 5f 6f  62 72 61 5f 69 64 2c 20   terial_obra_id, 
3c70	74 69 70 6f 2c 20 71 75  61 6e 74 69 64 61 64 65   tipo, quantidade
3c80	2c 20 65 74 61 70 61 5f  6f 62 72 61 2c 20 6d 6f   , etapa_obra, mo
3c90	74 69 76 6f 2c 20 64 6f  63 75 6d 65 6e 74 6f 2c   tivo, documento,
3ca0	20 72 65 73 70 6f 6e 73  61 76 65 6c 5f 69 64 2c    responsavel_id,
3cb0	20 64 61 74 61 5f 6d 6f  76 69 6d 65 6e 74 61 63    data_movimentac
3cc0	61 6f 2c 20 6f 62 73 65  72 76 61 63 6f 65 73 29   ao, observacoes)
3cd0	0d 0a 20 56 41 4c 55 45  53 20 28 3f 2c 20 3f 2c   .. VALUES (?, ?,
3ce0	20 27 65 6e 74 72 61 64  61 27 2c 20 3f 2c 20 3f    'entrada', ?, ?
3cf0	2c 20 3f 2c 20 3f 2c 20  3f 2c 20 3f 2c 20 3f 29   , ?, ?, ?, ?, ?)
3d00	0d 0a 20 60 2c 20 5b 0d  0a 20 6f 62 72 61 49 64   .. `, [.. obraId
3d10	2c 0d 0a 20 6d 61 74 65  72 69 61 6c 5f 6f 62 72   ,.. material_obr
3d20	61 5f 69 64 2c 0d 0a 20  71 75 61 6e 74 69 64 61   a_id,.. quantida
3d30	64 65 2c 0d 0a 20 65 74  61 70 61 5f 6f 62 72 61   de,.. etapa_obra
3d40	20 7c 7c 20 6e 75 6c 6c  2c 0d 0a 20 6d 6f 74 69    || null,.. moti
3d50	76 6f 20 7c 7c 20 27 45  6e 74 72 61 64 61 20 64   vo || 'Entrada d
3d60	65 20 6d 61 74 65 72 69  61 6c 20 6e 61 20 6f 62   e material na ob
3d70	72 61 27 2c 0d 0a 20 64  6f 63 75 6d 65 6e 74 6f   ra',.. documento
3d80	20 7c 7c 20 6e 75 6c 6c  2c 0d 0a 20 72 65 71 2e    || null,.. req.
3d90	73 65 73 73 69 6f 6e 2e  61 64 6d 69 6e 49 64 2c   session.adminId,
3da0	0d 0a 20 64 61 74 61 5f  6d 6f 76 69 6d 65 6e 74   .. data_moviment
3db0	61 63 61 6f 20 7c 7c 20  6e 65 77 20 44 61 74 65   acao || new Date
3dc0	28 29 2e 74 6f 49 53 4f  53 74 72 69 6e 67 28 29   ().toISOString()
3dd0	2e 73 70 6c 69 74 28 27  54 27 29 5b 30 5d 2c 0d   .split('T')[0],.
3de0	0a 20 6f 62 73 65 72 76  61 63 6f 65 73 20 7c 7c   . observacoes ||
3df0	20 6e 75 6c 6c 0d 0a 20  5d 29 3b 0d 0a 0d 0a 20    null.. ]);.... 
3e00	72 65 73 2e 72 65 64 69  72 65 63 74 28 60 2f 64   res.redirect(`/d
3e10	61 73 68 62 6f 61 72 64  2f 63 6f 6e 74 72 6f 6c   ashboard/control
3e20	65 20 67 65 72 61 6c 2f  65 73 74 6f 71 75 65 2f   e geral/estoque/
3e30	6f 62 72 61 2f 24 7b 6f  62 72 61 49 64 7d 2f 6d   obra/${obraId}/m
3e40	6f 76 69 6d 65 6e 74 61  63 6f 65 73 60 29 3b 0d   ovimentacoes`);.
3e50	0a 20 7d 20 63 61 74 63  68 20 28 65 72 72 29 20   . } catch (err) 
3e60	7b 0d 0a 20 63 6f 6e 73  6f 6c 65 2e 65 72 72 6f   {.. console.erro
3e70	72 28 27 45 72 72 6f 20  61 6f 20 72 65 67 69 73   r('Erro ao regis
3e80	74 72 61 72 20 65 6e 74  72 61 64 61 20 6e 61 20   trar entrada na 
3e90	6f 62 72 61 3a 27 2c 20  65 72 72 29 3b 0d 0a 20   obra:', err);.. 
3ea0	72 65 73 2e 73 74 61 74  75 73 28 35 30 30 29 2e   res.status(500).
3eb0	73 65 6e 64 28 27 45 72  72 6f 20 69 6e 74 65 72   send('Erro inter
3ec0	6e 6f 20 64 6f 20 73 65  72 76 69 64 6f 72 27 29   no do servidor')
3ed0	3b 0d 0a 20 7d 0d 0a 7d  3b 0d 0a 0d 0a 65 78 70   ;.. }..};....exp
3ee0	6f 72 74 73 2e 72 65 67  69 73 74 72 61 72 53 61   orts.registrarSa
3ef0	69 64 61 4f 62 72 61 20  3d 20 61 73 79 6e 63 20   idaObra = async 
3f00	28 72 65 71 2c 20 72 65  73 29 20 3d 3e 20 7b 0d   (req, res) => {.
3f10	0a 20 74 72 79 20 7b 0d  0a 20 63 6f 6e 73 74 20   . try {.. const 
3f20	6f 62 72 61 49 64 20 3d  20 72 65 71 2e 70 61 72   obraId = req.par
3f30	61 6d 73 2e 6f 62 72 61  5f 69 64 3b 0d 0a 20 63   ams.obra_id;.. c
3f40	6f 6e 73 74 20 7b 20 6d  61 74 65 72 69 61 6c 5f   onst { material_
3f50	6f 62 72 61 5f 69 64 2c  20 71 75 61 6e 74 69 64   obra_id, quantid
3f60	61 64 65 2c 20 65 74 61  70 61 5f 6f 62 72 61 2c   ade, etapa_obra,
3f70	20 6d 6f 74 69 76 6f 2c  20 64 6f 63 75 6d 65 6e    motivo, documen
3f80	74 6f 2c 20 64 61 74 61  5f 6d 6f 76 69 6d 65 6e   to, data_movimen
3f90	74 61 63 61 6f 2c 20 6f  62 73 65 72 76 61 63 6f   tacao, observaco
3fa0	65 73 20 7d 20 3d 20 72  65 71 2e 62 6f 64 79 3b   es } = req.body;
3fb0	0d 0a 0d 0a 20 61 77 61  69 74 20 6d 61 69 6e 44   .... await mainD
3fc0	62 2e 65 78 65 63 75 74  65 28 60 0d 0a 20 49 4e   b.execute(`.. IN
3fd0	53 45 52 54 20 49 4e 54  4f 20 6d 6f 76 69 6d 65   SERT INTO movime
3fe0	6e 74 61 63 6f 65 73 5f  6f 62 72 61 0d 0a 20 28   ntacoes_obra.. (
3ff0	6f 62 72 61 5f 69 64 2c  20 6d 61 74 65 72 69 61   obra_id, materia
4000	6c 5f 6f 62 72 61 5f 69  64 2c 20 74 69 70 6f 2c   l_obra_id, tipo,
4010	20 71 75 61 6e 74 69 64  61 64 65 2c 20 65 74 61    quantidade, eta
4020	70 61 5f 6f 62 72 61 2c  20 6d 6f 74 69 76 6f 2c   pa_obra, motivo,
4030	20 64 6f 63 75 6d 65 6e  74 6f 2c 20 72 65 73 70    documento, resp
4040	6f 6e 73 61 76 65 6c 5f  69 64 2c 20 64 61 74 61   onsavel_id, data
4050	5f 6d 6f 76 69 6d 65 6e  74 61 63 61 6f 2c 20 6f   _movimentacao, o
4060	62 73 65 72 76 61 63 6f  65 73 29 0d 0a 20 56 41   bservacoes).. VA
4070	4c 55 45 53 20 28 3f 2c  20 3f 2c 20 27 73 61 69   LUES (?, ?, 'sai
4080	64 61 27 2c 20 3f 2c 20  3f 2c 20 3f 2c 20 3f 2c   da', ?, ?, ?, ?,
4090	20 3f 2c 20 3f 2c 20 3f  29 0d 0a 20 60 2c 20 5b    ?, ?, ?).. `, [
40a0	0d 0a 20 6f 62 72 61 49  64 2c 0d 0a 20 6d 61 74   .. obraId,.. mat
40b0	65 72 69 61 6c 5f 6f 62  72 61 5f 69 64 2c 0d 0a   erial_obra_id,..
40c0	20 71 75 61 6e 74 69 64  61 64 65 2c 0d 0a 20 65    quantidade,.. e
40d0	74 61 70 61 5f 6f 62 72  61 2c 0d 0a 20 6d 6f 74   tapa_obra,.. mot
40e0	69 76 6f 20 7c 7c 20 27  43 6f 6e 73 75 6d 6f 20   ivo || 'Consumo 
40f0	6e 61 20 6f 62 72 61 27  2c 0d 0a 20 64 6f 63 75   na obra',.. docu
4100	6d 65 6e 74 6f 20 7c 7c  20 6e 75 6c 6c 2c 0d 0a   mento || null,..
4110	20 72 65 71 2e 73 65 73  73 69 6f 6e 2e 61 64 6d    req.session.adm
4120	69 6e 49 64 2c 0d 0a 20  64 61 74 61 5f 6d 6f 76   inId,.. data_mov
4130	69 6d 65 6e 74 61 63 61  6f 20 7c 7c 20 6e 65 77   imentacao || new
4140	20 44 61 74 65 28 29 2e  74 6f 49 53 4f 53 74 72    Date().toISOStr
4150	69 6e 67 28 29 2e 73 70  6c 69 74 28 27 54 27 29   ing().split('T')
4160	5b 30 5d 2c 0d 0a 20 6f  62 73 65 72 76 61 63 6f   [0],.. observaco
4170	65 73 20 7c 7c 20 6e 75  6c 6c 0d 0a 20 5d 29 3b   es || null.. ]);
4180	0d 0a 0d 0a 20 72 65 73  2e 72 65 64 69 72 65 63   .... res.redirec
4190	74 28 60 2f 64 61 73 68  62 6f 61 72 64 2f 63 6f   t(`/dashboard/co
41a0	6e 74 72 6f 6c 65 20 67  65 72 61 6c 2f 65 73 74   ntrole geral/est
41b0	6f 71 75 65 2f 6f 62 72  61 2f 24 7b 6f 62 72 61   oque/obra/${obra
41c0	49 64 7d 2f 6d 6f 76 69  6d 65 6e 74 61 63 6f 65   Id}/movimentacoe
41d0	73 60 29 3b 0d 0a 20 7d  20 63 61 74 63 68 20 28   s`);.. } catch (
41e0	65 72 72 29 20 7b 0d 0a  20 63 6f 6e 73 6f 6c 65   err) {.. console
41f0	2e 65 72 72 6f 72 28 27  45 72 72 6f 20 61 6f 20   .error('Erro ao 
4200	72 65 67 69 73 74 72 61  72 20 73 61 c3 ad 64 61   registrar sa..da
4210	20 64 61 20 6f 62 72 61  3a 27 2c 20 65 72 72 29    da obra:', err)
4220	3b 0d 0a 20 72 65 73 2e  73 74 61 74 75 73 28 35   ;.. res.status(5
4230	30 30 29 2e 73 65 6e 64  28 27 45 72 72 6f 20 69   00).send('Erro i
4240	6e 74 65 72 6e 6f 20 64  6f 20 73 65 72 76 69 64   nterno do servid
4250	6f 72 27 29 3b 0d 0a 20  7d 0d 0a 7d 3b 0d 0a 0d   or');.. }..};...
4260	0a 2f 2f 20 52 45 4c 41  54 c3 93 52 49 4f 53 0d   .// RELAT..RIOS.
4270	0a 65 78 70 6f 72 74 73  2e 72 65 6c 61 74 6f 72   .exports.relator
4280	69 6f 73 20 3d 20 61 73  79 6e 63 20 28 72 65 71   ios = async (req
4290	2c 20 72 65 73 29 20 3d  3e 20 7b 0d 0a 20 74 72   , res) => {.. tr
42a0	79 20 7b 0d 0a 20 63 6f  6e 73 74 20 5b 72 65 6c   y {.. const [rel
42b0	61 74 6f 72 69 6f 73 5d  20 3d 20 61 77 61 69 74   atorios] = await
42c0	20 64 62 2e 65 78 65 63  75 74 65 28 60 0d 0a 20    db.execute(`.. 
42d0	53 45 4c 45 43 54 20 72  2e 2a 2c 20 6f 2e 6e 6f   SELECT r.*, o.no
42e0	6d 65 5f 6f 62 72 61 20  61 73 20 6f 62 72 61 5f   me_obra as obra_
42f0	6e 6f 6d 65 0d 0a 20 46  52 4f 4d 20 72 65 6c 61   nome.. FROM rela
4300	74 6f 72 69 6f 73 20 72  0d 0a 20 4c 45 46 54 20   torios r.. LEFT 
4310	4a 4f 49 4e 20 6f 62 72  61 73 20 6f 20 4f 4e 20   JOIN obras o ON 
4320	72 2e 6f 62 72 61 5f 69  64 20 3d 20 6f 2e 69 64   r.obra_id = o.id
4330	0d 0a 20 4f 52 44 45 52  20 42 59 20 72 2e 69 64   .. ORDER BY r.id
4340	20 44 45 53 43 0d 0a 20  60 29 3b 0d 0a 20 2f 2f    DESC.. `);.. //
4350	20 42 75 73 63 61 72 20  6f 62 72 61 73 20 70 61    Buscar obras pa
4360	72 61 20 6f 20 64 72 6f  70 64 6f 77 6e 0d 0a 20   ra o dropdown.. 
4370	63 6f 6e 73 74 20 5b 6f  62 72 61 73 5d 20 3d 20   const [obras] = 
4380	61 77 61 69 74 20 64 62  2e 65 78 65 63 75 74 65   await db.execute
4390	28 27 53 45 4c 45 43 54  20 69 64 2c 20 6e 6f 6d   ('SELECT id, nom
43a0	65 5f 6f 62 72 61 20 61  73 20 6e 6f 6d 65 20 46   e_obra as nome F
43b0	52 4f 4d 20 6f 62 72 61  73 20 4f 52 44 45 52 20   ROM obras ORDER 
43c0	42 59 20 6e 6f 6d 65 5f  6f 62 72 61 27 29 3b 0d   BY nome_obra');.
43d0	0a 20 72 65 73 2e 72 65  6e 64 65 72 28 27 72 65   . res.render('re
43e0	6c 61 74 6f 72 69 6f 73  27 2c 20 7b 20 72 65 6c   latorios', { rel
43f0	61 74 6f 72 69 6f 73 3a  20 72 65 6c 61 74 6f 72   atorios: relator
4400	69 6f 73 20 7c 7c 20 5b  5d 2c 20 6f 62 72 61 73   ios || [], obras
4410	3a 20 6f 62 72 61 73 20  7c 7c 20 5b 5d 20 7d 29   : obras || [] })
4420	3b 0d 0a 20 7d 20 63 61  74 63 68 20 28 65 72 72   ;.. } catch (err
4430	29 20 7b 0d 0a 20 63 6f  6e 73 6f 6c 65 2e 65 72   ) {.. console.er
4440	72 6f 72 28 27 45 72 72  6f 20 61 6f 20 63 61 72   ror('Erro ao car
4450	72 65 67 61 72 20 72 65  6c 61 74 c3 b3 72 69 6f   regar relat..rio
4460	73 3a 27 2c 20 65 72 72  29 3b 0d 0a 20 72 65 73   s:', err);.. res
4470	2e 73 74 61 74 75 73 28  35 30 30 29 2e 72 65 6e   .status(500).ren
4480	64 65 72 28 27 65 72 72  6f 72 27 2c 20 7b 20 6d   der('error', { m
4490	65 73 73 61 67 65 3a 20  27 45 72 72 6f 20 69 6e   essage: 'Erro in
44a0	74 65 72 6e 6f 20 64 6f  20 73 65 72 76 69 64 6f   terno do servido
44b0	72 27 20 7d 29 3b 0d 0a  20 7d 0d 0a 7d 3b 0d 0a   r' });.. }..};..
44c0	0d 0a 65 78 70 6f 72 74  73 2e 63 72 69 61 72 52   ..exports.criarR
44d0	65 6c 61 74 6f 72 69 6f  20 3d 20 61 73 79 6e 63   elatorio = async
44e0	20 28 72 65 71 2c 20 72  65 73 29 20 3d 3e 20 7b    (req, res) => {
44f0	0d 0a 20 74 72 79 20 7b  0d 0a 20 63 6f 6e 73 74   .. try {.. const
4500	20 7b 20 74 69 74 75 6c  6f 2c 20 64 65 73 63 72    { titulo, descr
4510	69 63 61 6f 2c 20 74 69  70 6f 2c 20 64 61 74 61   icao, tipo, data
4520	2c 20 6f 62 72 61 5f 69  64 20 7d 20 3d 20 72 65   , obra_id } = re
4530	71 2e 62 6f 64 79 3b 0d  0a 20 61 77 61 69 74 20   q.body;.. await 
4540	64 62 2e 65 78 65 63 75  74 65 28 60 49 4e 53 45   db.execute(`INSE
4550	52 54 20 49 4e 54 4f 20  72 65 6c 61 74 6f 72 69   RT INTO relatori
4560	6f 73 20 28 74 69 74 75  6c 6f 2c 20 64 65 73 63   os (titulo, desc
4570	72 69 63 61 6f 2c 20 74  69 70 6f 2c 20 64 61 74   ricao, tipo, dat
4580	61 2c 20 6f 62 72 61 5f  69 64 29 20 56 41 4c 55   a, obra_id) VALU
4590	45 53 20 28 3f 2c 20 3f  2c 20 3f 2c 20 3f 2c 20   ES (?, ?, ?, ?, 
45a0	3f 29 60 2c 0d 0a 20 5b  74 69 74 75 6c 6f 20 7c   ?)`,.. [titulo |
45b0	7c 20 6e 75 6c 6c 2c 20  64 65 73 63 72 69 63 61   | null, descrica
45c0	6f 20 7c 7c 20 6e 75 6c  6c 2c 20 74 69 70 6f 20   o || null, tipo 
45d0	7c 7c 20 6e 75 6c 6c 2c  20 64 61 74 61 20 7c 7c   || null, data ||
45e0	20 6e 75 6c 6c 2c 20 6f  62 72 61 5f 69 64 20 7c    null, obra_id |
45f0	7c 20 6e 75 6c 6c 5d 29  3b 0d 0a 20 72 65 73 2e   | null]);.. res.
4600	72 65 64 69 72 65 63 74  28 27 2f 64 61 73 68 62   redirect('/dashb
4610	6f 61 72 64 2f 63 6f 6e  74 72 6f 6c 65 20 67 65   oard/controle ge
4620	72 61 6c 2f 72 65 6c 61  74 6f 72 69 6f 73 27 29   ral/relatorios')
4630	3b 0d 0a 20 7d 20 63 61  74 63 68 20 28 65 72 72   ;.. } catch (err
4640	29 20 7b 0d 0a 20 63 6f  6e 73 6f 6c 65 2e 65 72   ) {.. console.er
4650	72 6f 72 28 27 45 72 72  6f 20 61 6f 20 63 72 69   ror('Erro ao cri
4660	61 72 20 72 65 6c 61 74  c3 b3 72 69 6f 3a 27 2c   ar relat..rio:',
4670	20 65 72 72 29 3b 0d 0a  20 72 65 73 2e 73 74 61    err);.. res.sta
4680	74 75 73 28 35 30 30 29  2e 6a 73 6f 6e 28 7b 20   tus(500).json({ 
4690	65 72 72 6f 72 3a 20 27  45 72 72 6f 20 69 6e 74   error: 'Erro int
46a0	65 72 6e 6f 20 64 6f 20  73 65 72 76 69 64 6f 72   erno do servidor
46b0	27 20 7d 29 3b 0d 0a 20  7d 0d 0a 20 7d 3b 0d 0a   ' });.. }.. };..
46c0	0d 0a 65 78 70 6f 72 74  73 2e 65 78 63 6c 75 69   ..exports.exclui
46d0	72 52 65 6c 61 74 6f 72  69 6f 20 3d 20 61 73 79   rRelatorio = asy
46e0	6e 63 20 28 72 65 71 2c  20 72 65 73 29 20 3d 3e   nc (req, res) =>
46f0	20 7b 0d 0a 20 74 72 79  20 7b 0d 0a 20 63 6f 6e    {.. try {.. con
4700	73 74 20 7b 20 69 64 20  7d 20 3d 20 72 65 71 2e   st { id } = req.
4710	70 61 72 61 6d 73 3b 0d  0a 20 61 77 61 69 74 20   params;.. await 
4720	64 62 2e 65 78 65 63 75  74 65 28 27 44 45 4c 45   db.execute('DELE
4730	54 45 20 46 52 4f 4d 20  72 65 6c 61 74 6f 72 69   TE FROM relatori
4740	6f 73 20 57 48 45 52 45  20 69 64 20 3d 20 3f 27   os WHERE id = ?'
4750	2c 20 5b 69 64 5d 29 3b  0d 0a 20 72 65 73 2e 72   , [id]);.. res.r
4760	65 64 69 72 65 63 74 28  27 2f 64 61 73 68 62 6f   edirect('/dashbo
4770	61 72 64 2f 63 6f 6e 74  72 6f 6c 65 20 67 65 72   ard/controle ger
4780	61 6c 2f 72 65 6c 61 74  6f 72 69 6f 73 27 29 3b   al/relatorios');
4790	0d 0a 20 7d 20 63 61 74  63 68 20 28 65 72 72 29   .. } catch (err)
47a0	20 7b 0d 0a 20 63 6f 6e  73 6f 6c 65 2e 65 72 72    {.. console.err
47b0	6f 72 28 27 45 72 72 6f  20 61 6f 20 65 78 63 6c   or('Erro ao excl
47c0	75 69 72 20 72 65 6c 61  74 c3 b3 72 69 6f 3a 27   uir relat..rio:'
47d0	2c 20 65 72 72 29 3b 0d  0a 20 72 65 73 2e 73 74   , err);.. res.st
47e0	61 74 75 73 28 35 30 30  29 2e 72 65 6e 64 65 72   atus(500).render
47f0	28 27 65 72 72 6f 72 27  2c 20 7b 20 6d 65 73 73   ('error', { mess
4800	61 67 65 3a 20 27 45 72  72 6f 20 69 6e 74 65 72   age: 'Erro inter
4810	6e 6f 20 64 6f 20 73 65  72 76 69 64 6f 72 27 20   no do servidor' 
4820	7d 29 3b 0d 0a 20 7d 0d  0a 7d 3b 0d 0a 0d 0a 0d   });.. }..};.....
4830	0a 0d 0a 0d 0a                                     .....
