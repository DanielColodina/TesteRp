<link rel="stylesheet" href="/css/dashboard-progresso.css">

<div class="app-layout">
  <aside class="sidebar sidebar-closed">
    <div class="sidebar-header">
      <div class="logo">RP</div>
    </div>
    <nav class="sidebar-nav">
      <a href="/dashboard" class="nav-item">
        <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
      </a>
      <a href="/dashboard/usuarios" class="nav-item">
        <i class="fas fa-users"></i> <span>Usu√°rios</span>
      </a>
      <a href="/dashboard/obras" class="nav-item">
        <i class="fas fa-hard-hat"></i> <span>Obras</span>
      </a>
      <a href="/dashboard/progresso" class="nav-item active">
        <i class="fas fa-chart-line"></i> <span>Progresso</span>
      </a>
      <a href="/dashboard/controle-geral" class="nav-item">
        <i class="fas fa-cogs"></i> <span>Controle</span>
      </a>
      <a href="/dashboard/historico" class="nav-item">
        <i class="fas fa-history"></i> <span>Hist√≥rico</span>
      </a>
      <a href="/dashboard/auditoria" class="nav-item">
        <i class="fas fa-search"></i> <span>Auditoria</span>
      </a>
    </nav>
    <div class="sidebar-footer">
      <a href="/logout" class="btn-logout">Sair</a>
    </div>
  </aside>

  <main class="main-content sidebar-closed">
    <div class="top-bar">
      <button class="sidebar-toggle">
        <i class="fas fa-bars"></i>
      </button>
      <h1><i class="fas fa-chart-line"></i> Dashboard de Progresso das Obras</h1>
      <a href="/dashboard" class="btn btn-secondary">‚Üê Voltar</a>
    </div>

    <div class="app-container">
      <!-- ESTAT√çSTICAS GERAIS -->
      <div class="grid grid-3">
        <div class="card">
          <h3 class="stat-label"><i class="fas fa-chart-line"></i> Progresso M√©dio</h3>
          <p class="stat-value">{{progressoMedio}}%</p>
        </div>

        <div class="card">
          <h3 class="stat-label"><i class="fas fa-check-circle"></i> Obras Completas</h3>
          <p class="stat-value">{{obrasCompletas}} / {{totalObras}}</p>
        </div>

        <div class="card">
          <h3 class="stat-label"><i class="fas fa-hard-hat"></i> Total de Obras</h3>
          <p class="stat-value">{{totalObras}}</p>
        </div>
      </div>

      <!-- TABELA DE PROGRESSO -->
      <div class="card">
        <h2><i class="fas fa-chart-line"></i> Progresso por Obra</h2>

        {{#if checklists}}
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Obra</th>
                <th>Uso do Solo</th>
                <th>Licen√ßa</th>
                <th>Condom√≠nio</th>
                <th>Habite-se</th>
                <th>Averba√ß√£o</th>
                <th>Vistoria</th>
                <th>Progresso</th>
              </tr>
            </thead>
            <tbody>
              {{#each checklists}}
                <tr>
                  <td>{{usuario_id}}</td>
                  <td>{{nome}}</td>
                  <td>{{obra}}</td>
                  <td>
                    {{#if (eq uso_solo 'Feito')}}
                      <span class="status-done">‚úÖ Feito</span>
                    {{else if (eq uso_solo 'Andamento')}}
                      <span class="status-progress">‚è≥ Andamento</span>
                    {{else if (eq uso_solo 'Nao Tem')}}
                      <span class="status-none">‚è∏Ô∏è N√£o Tem</span>
                    {{else}}
                      <span class="status-default">{{uso_solo}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq licenca 'Feito')}}
                      <span class="status-done"><i class="fas fa-check"></i> Feito</span>
                    {{else if (eq licenca 'Andamento')}}
                      <span class="status-progress"><i class="fas fa-clock"></i> Andamento</span>
                    {{else if (eq licenca 'Nao Tem')}}
                      <span class="status-none"><i class="fas fa-pause"></i> N√£o Tem</span>
                    {{else}}
                      <span class="status-default">{{licenca}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq condominio 'Feito')}}
                      <span class="status-done">‚úÖ Feito</span>
                    {{else if (eq condominio 'Andamento')}}
                      <span class="status-progress">‚è≥ Andamento</span>
                    {{else if (eq condominio 'Nao Tem')}}
                      <span class="status-none">‚è∏Ô∏è N√£o Tem</span>
                    {{else}}
                      <span class="status-default">{{condominio}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq habite_se 'Feito')}}
                      <span class="status-done"><i class="fas fa-check"></i> Feito</span>
                    {{else if (eq habite_se 'Andamento')}}
                      <span class="status-progress"><i class="fas fa-clock"></i> Andamento</span>
                    {{else if (eq habite_se 'Nao Tem')}}
                      <span class="status-none"><i class="fas fa-pause"></i> N√£o Tem</span>
                    {{else}}
                      <span class="status-default">{{habite_se}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq averbacao 'Feito')}}
                      <span class="status-done">‚úÖ Feito</span>
                    {{else if (eq averbacao 'Andamento')}}
                      <span class="status-progress">‚è≥ Andamento</span>
                    {{else if (eq averbacao 'Nao Tem')}}
                      <span class="status-none">‚è∏Ô∏è N√£o Tem</span>
                    {{else}}
                      <span class="status-default">{{averbacao}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq vistoria 'Feito')}}
                      <span class="status-done"><i class="fas fa-check"></i> Feito</span>
                    {{else if (eq vistoria 'Andamento')}}
                      <span class="status-progress"><i class="fas fa-clock"></i> Andamento</span>
                    {{else if (eq vistoria 'Nao Tem')}}
                      <span class="status-none"><i class="fas fa-pause"></i> N√£o Tem</span>
                    {{else}}
                      <span class="status-default">{{vistoria}}</span>
                    {{/if}}
                  </td>
                  <td>
                    <div class="progress-bar-container">
                      <div class="progress-bar" style="width: {{progresso}}%;">
                        <span class="progress-text">{{progresso}}%</span>
                      </div>
                    </div>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        {{else}}
          <p class="text-center" style="color: #B0B0B0; padding: 20px;">Nenhuma obra cadastrada.</p>
        {{/if}}
      </div>

      <!-- SE√á√ïES DE HIST√ìRICO E AUDITORIA -->
      <div class="grid grid-2">
        <div class="card">
          <h3>üìú Hist√≥rico Recente</h3>
          {{#if historicoRecente}}
            <ul class="info-list">
              {{#each historicoRecente}}
                <li>
                  <strong style="color: #FFC300;">{{usuario_nome}}</strong> - {{obra}}
                  <br>
                  <span>{{tipo}}: {{descricao}}</span>
                  <br>
                  <small>Por: {{admin_nome}} | {{created_at}}</small>
                </li>
              {{/each}}
            </ul>
          {{else}}
            <p class="text-center" style="color: #B0B0B0;">Nenhum hist√≥rico registrado.</p>
          {{/if}}
        </div>

        <div class="card">
          <h3>√öltimos Logs de Auditoria</h3>
          {{#if auditoria}}
            <ul class="info-list">
              {{#each auditoria}}
                <li>
                  <strong style="color: #FFC300;">{{acao}}</strong>
                  <br>
                  <span>Usu√°rio: {{usuario_nome}} | Admin: {{admin_nome}}</span>
                  <br>
                  <small>Campo: {{campo}} | {{created_at}}</small>
                </li>
              {{/each}}
            </ul>
          {{else}}
            <p class="text-center" style="color: #B0B0B0;">Nenhuma auditoria registrada.</p>
          {{/if}}
        </div>
      </div>

      <!-- LINKS DE A√á√ÉO -->
      <div class="flex gap-15 justify-center">
        <a href="/dashboard/auditoria" class="btn btn-primary">üîí Ver Auditoria Completa</a>
        <a href="/dashboard/historico" class="btn btn-primary">üìú Ver Hist√≥rico Completo</a>
      </div>
    </div>
  </main>
</div>

{{!-- Helper para comparar valores --}}
<script>
  Handlebars.registerHelper('eq', function(a, b) {
    return a === b;
  });
</script>

<script src="/js/sidebar.js"></script>
